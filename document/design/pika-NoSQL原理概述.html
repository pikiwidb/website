<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>pika-NoSQL原理概述 | Pika 文档</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/pika-logo-trans.png">
    <meta name="description" content=" ">
    
    <link rel="preload" href="/assets/css/0.styles.f6912c97.css" as="style"><link rel="preload" href="/assets/js/app.32d1b42e.js" as="script"><link rel="preload" href="/assets/js/7.1224f65b.js" as="script"><link rel="preload" href="/assets/js/2.9fbd6685.js" as="script"><link rel="preload" href="/assets/js/1.77f24ecd.js" as="script"><link rel="preload" href="/assets/js/49.37fdc54d.js" as="script"><link rel="prefetch" href="/assets/js/10.dfb0299a.js"><link rel="prefetch" href="/assets/js/11.479e3941.js"><link rel="prefetch" href="/assets/js/14.65104886.js"><link rel="prefetch" href="/assets/js/15.0fe19f29.js"><link rel="prefetch" href="/assets/js/16.3a98beb2.js"><link rel="prefetch" href="/assets/js/17.85dc844f.js"><link rel="prefetch" href="/assets/js/18.060d220d.js"><link rel="prefetch" href="/assets/js/19.77ed2e0b.js"><link rel="prefetch" href="/assets/js/20.1faabea6.js"><link rel="prefetch" href="/assets/js/21.4913a81b.js"><link rel="prefetch" href="/assets/js/22.ec2bffa8.js"><link rel="prefetch" href="/assets/js/23.77700c61.js"><link rel="prefetch" href="/assets/js/24.6badfe0e.js"><link rel="prefetch" href="/assets/js/25.bda1b3e1.js"><link rel="prefetch" href="/assets/js/26.06377f0d.js"><link rel="prefetch" href="/assets/js/27.86112ea9.js"><link rel="prefetch" href="/assets/js/28.be8ca15b.js"><link rel="prefetch" href="/assets/js/29.98f0eb72.js"><link rel="prefetch" href="/assets/js/3.50c72d76.js"><link rel="prefetch" href="/assets/js/30.4c7947d3.js"><link rel="prefetch" href="/assets/js/31.aa1f8d83.js"><link rel="prefetch" href="/assets/js/32.bac8f00d.js"><link rel="prefetch" href="/assets/js/33.cb9d2429.js"><link rel="prefetch" href="/assets/js/34.380ce34c.js"><link rel="prefetch" href="/assets/js/35.b5fcd8bd.js"><link rel="prefetch" href="/assets/js/36.34421d06.js"><link rel="prefetch" href="/assets/js/37.974c194a.js"><link rel="prefetch" href="/assets/js/38.2d40b9d6.js"><link rel="prefetch" href="/assets/js/39.5d62c31a.js"><link rel="prefetch" href="/assets/js/4.ab7c6b55.js"><link rel="prefetch" href="/assets/js/40.68bd83a3.js"><link rel="prefetch" href="/assets/js/41.fbd626e2.js"><link rel="prefetch" href="/assets/js/42.a61eadfa.js"><link rel="prefetch" href="/assets/js/43.a632a507.js"><link rel="prefetch" href="/assets/js/44.f4ae27e8.js"><link rel="prefetch" href="/assets/js/45.0e21b553.js"><link rel="prefetch" href="/assets/js/46.f9d98439.js"><link rel="prefetch" href="/assets/js/47.e53fc68e.js"><link rel="prefetch" href="/assets/js/48.05b6338a.js"><link rel="prefetch" href="/assets/js/5.8a3b91a7.js"><link rel="prefetch" href="/assets/js/50.52457c11.js"><link rel="prefetch" href="/assets/js/51.367b8ed7.js"><link rel="prefetch" href="/assets/js/52.d853b4e0.js"><link rel="prefetch" href="/assets/js/53.2b0e710e.js"><link rel="prefetch" href="/assets/js/54.2dda43eb.js"><link rel="prefetch" href="/assets/js/55.e357ec1f.js"><link rel="prefetch" href="/assets/js/56.35e28277.js"><link rel="prefetch" href="/assets/js/57.712bde78.js"><link rel="prefetch" href="/assets/js/58.efe86a06.js"><link rel="prefetch" href="/assets/js/59.4223290f.js"><link rel="prefetch" href="/assets/js/6.2727d8db.js"><link rel="prefetch" href="/assets/js/60.52835ede.js"><link rel="prefetch" href="/assets/js/61.6dffea07.js"><link rel="prefetch" href="/assets/js/62.9121468e.js"><link rel="prefetch" href="/assets/js/63.55f28f07.js"><link rel="prefetch" href="/assets/js/64.bf9e1a4f.js"><link rel="prefetch" href="/assets/js/65.6994aa90.js"><link rel="prefetch" href="/assets/js/66.76eb1c15.js"><link rel="prefetch" href="/assets/js/67.f9241870.js"><link rel="prefetch" href="/assets/js/68.6e1e4216.js"><link rel="prefetch" href="/assets/js/69.442140c3.js"><link rel="prefetch" href="/assets/js/70.dc405d26.js"><link rel="prefetch" href="/assets/js/71.b2386ab3.js"><link rel="prefetch" href="/assets/js/72.eba4d61c.js"><link rel="prefetch" href="/assets/js/73.833b4b7a.js"><link rel="prefetch" href="/assets/js/74.24d21aeb.js"><link rel="prefetch" href="/assets/js/75.cbcf9227.js"><link rel="prefetch" href="/assets/js/76.e9ed2912.js"><link rel="prefetch" href="/assets/js/77.d8ed397f.js"><link rel="prefetch" href="/assets/js/78.96639754.js"><link rel="prefetch" href="/assets/js/79.79f3a85f.js"><link rel="prefetch" href="/assets/js/8.617b6635.js"><link rel="prefetch" href="/assets/js/80.ccf3c9fe.js"><link rel="prefetch" href="/assets/js/81.051f57a1.js"><link rel="prefetch" href="/assets/js/82.c775bb2e.js"><link rel="prefetch" href="/assets/js/83.dba45c87.js"><link rel="prefetch" href="/assets/js/84.5c7295ac.js"><link rel="prefetch" href="/assets/js/85.7f822be4.js"><link rel="prefetch" href="/assets/js/86.23e94d91.js"><link rel="prefetch" href="/assets/js/87.216ac4f8.js"><link rel="prefetch" href="/assets/js/88.1ffdea5b.js"><link rel="prefetch" href="/assets/js/89.02556523.js"><link rel="prefetch" href="/assets/js/9.cf1faa69.js"><link rel="prefetch" href="/assets/js/90.4d31e342.js"><link rel="prefetch" href="/assets/js/91.1b4fc56c.js"><link rel="prefetch" href="/assets/js/92.e48a904d.js"><link rel="prefetch" href="/assets/js/93.44ea7cfe.js"><link rel="prefetch" href="/assets/js/94.76ce1c72.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.c040f9c6.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f6912c97.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>Pika 文档</h3> <p class="description" data-v-59e6cb88> </p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>Pika</span>
          
        <span data-v-59e6cb88>2015 - </span>
        2024
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/pika-smalllogo.png" alt="Pika 文档" class="logo"> <span class="site-name">Pika 文档</span></a> <div class="links"><!----> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><a href="/document/Pika介绍.html" class="nav-link"><i class="undefined"></i>
  文档
</a></div><div class="nav-item"><a href="https://github.com/OpenAtomFoundation/pika" target="_blank" rel="noopener noreferrer" class="nav-link external"><i></i>
  文档仓库
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><!----> <h3 class="name" data-v-1fad0c41>
    Pika
  </h3> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>56</h3> <h6 data-v-1fad0c41>Articles</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>0</h3> <h6 data-v-1fad0c41>Tags</h6></div></div> <ul class="social-links" data-v-1fad0c41></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><a href="/document/Pika介绍.html" class="nav-link"><i class="undefined"></i>
  文档
</a></div><div class="nav-item"><a href="https://github.com/OpenAtomFoundation/pika" target="_blank" rel="noopener noreferrer" class="nav-link external"><i></i>
  文档仓库
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav> <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/document/Pika介绍" class="sidebar-heading clickable"><span>概况</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/document/Pika介绍.html" class="sidebar-link">Pika介绍</a></li><li><a href="/document/use/支持的语言和客户端.html" class="sidebar-link">支持的语言和客户端</a></li><li><a href="/document/use/当前支持的Redis接口以及兼容情况.html" class="sidebar-link">支持的Redis接口</a></li><li><a href="/document/FAQ.html" class="sidebar-link">FAQ</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/document/use/安装使用" class="sidebar-heading clickable"><span>使用与运维</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/document/use/安装使用.html" class="sidebar-link">安装使用</a></li><li><a href="/document/use/配置文件说明.html" class="sidebar-link">配置文件</a></li><li><a href="/document/use/数据目录说明.html" class="sidebar-link">数据目录</a></li><li><a href="/document/use/info信息说明.html" class="sidebar-link">info信息</a></li><li><a href="/document/use/部分管理指令说明.html" class="sidebar-link">管理指令</a></li><li><a href="/document/use/差异化命令.html" class="sidebar-link">差异化命令</a></li><li><a href="/document/use/Pika订阅.html" class="sidebar-link">Pika订阅</a></li><li><a href="/document/use/配合sentinel实现pika自动容灾.html" class="sidebar-link">自动容灾</a></li><li><a href="/document/use/Pika多库版命令.html" class="sidebar-link">多库版命令</a></li><li><a href="/document/use/Pika分片.html" class="sidebar-link">分片教程</a></li><li><a href="/document/use/副本一致性使用说明.html" class="sidebar-link">副本一致性</a></li><li><a href="/document/use/Pika最佳实践.html" class="sidebar-link">最佳实践</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/document/use/如何实现3.3.6升级到3.5.x" class="sidebar-heading clickable"><span>升级指南</span> <span class="arrow right"></span></a> <!----></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>性能与优化</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/document/performance/3.2.x性能.html" class="sidebar-link">3.2.x性能</a></li><li><a href="/document/use/Pika内存使用.html" class="sidebar-link">Pika内存使用</a></li><li><a href="/document/performance/Redis与Pikascan性能对比.html" class="sidebar-link">Redis 与 Pika scan 性能对比</a></li><li><a href="/document/performance/Pika3.5参数优化手册.html" class="sidebar-link">Pika 3.5 参数优化手册</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Pika 优化案例</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>设计与实现</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/document/design/整体架构.html" class="sidebar-link">整体架构</a></li><li><a href="/document/design/线程模型.html" class="sidebar-link">线程模型</a></li><li><a href="/document/design/锁的应用.html" class="sidebar-link">锁的应用</a></li><li><a href="/document/design/全同步.html" class="sidebar-link">全同步</a></li><li><a href="/document/design/增量同步.html" class="sidebar-link">增量同步</a></li><li><a href="/document/design/pika主从同步原理.html" class="sidebar-link">主从同步</a></li><li><a href="/document/design/副本一致性.html" class="sidebar-link">副本一致性</a></li><li><a href="/document/design/pika在codis中的探索.html" class="sidebar-link">Pika 与 Codis</a></li><li><a href="/document/design/快照式备份.html" class="sidebar-link">快照式备份</a></li><li><a href="/document/design/pika-NoSQL原理概述.html" class="active sidebar-link">NoSQL 实现</a></li><li><a href="/document/design/blackwidow存储引擎数据格式.html" class="sidebar-link">旧存储结构</a></li><li><a href="/document/design/Pika新存储结构Floyd.html" class="sidebar-link">新存储结构 Floyd</a></li><li><a href="/document/design/floyd存储方案.html" class="sidebar-link">Floyd 详解</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/document/design/Pika源码学习study1" class="sidebar-heading clickable"><span>Pika 源码学习</span> <span class="arrow right"></span></a> <!----></section></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/document/develop/Pikacodingstyle" class="sidebar-heading clickable"><span>开发文档</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/document/develop/Pikacodingstyle.html" class="sidebar-link">Pika 开发规范</a></li><li><a href="/document/develop/pikacode.html" class="sidebar-link">Pika 代码梳理</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/tool/3.2.新旧可读三类binlog转换工具" class="sidebar-heading clickable"><span>工具包</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/document/tool/3.2.新旧可读三类binlog转换工具.html" class="sidebar-link">3.2.新，旧，可读三类binlog转换工具</a></li><li><a href="/document/tool/根据时间戳恢复数据工具.html" class="sidebar-link">根据时间戳恢复数据工具</a></li><li><a href="/document/tool/Redis到Pika迁移工具.html" class="sidebar-link">Redis到Pika迁移工具</a></li><li><a href="/document/tool/Redis请求实时copy到Pika工具.html" class="sidebar-link">Redis请求实时copy到Pika工具</a></li><li><a href="/document/tool/Pikatool1.html" class="sidebar-link">Pika到Pika、Redis迁移工具 Pika-Port(适用于 Pika v2.x&amp;v3.0.x)</a></li><li><a href="/document/tool/Pikatool2.html" class="sidebar-link">Pika到Pika、Redis迁移工具 Pika-Migrage(适用于 Pika v3.2及以上版本)</a></li><li><a href="/document/tool/Pika的kv数据写入txt文本工具.html" class="sidebar-link">Pika的kv数据写入txt文本工具</a></li><li><a href="/document/tool/kv数据txt文本迁移Pika工具.html" class="sidebar-link">kv数据txt文本迁移Pika工具</a></li><li><a href="/document/tool/pikaexporter监控工具.html" class="sidebar-link">pika exporter监控工具</a></li><li><a href="/document/tool/codis-redis实时同步pika工具.html" class="sidebar-link">codis-redis实时同步pika工具</a></li></ul></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>pika-NoSQL原理概述</h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>Pika</span>
          
        <span data-v-59e6cb88>2015 - </span>
        2024
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">pika-NoSQL原理概述</h1> <div data-v-8a445198><i class="iconfont reco-account" data-v-8a445198><span data-v-8a445198>Pika</span></i> <!----> <!----> <!----></div></div> <div class="theme-reco-content content__default"><h2 id="pika-设计"><a href="#pika-设计" class="header-anchor">#</a> pika 设计</h2> <p>pika 在设计的时候支持了两种运行模式，即经典模式和分布式模式。</p> <table><thead><tr><th>模式</th> <th>原理</th></tr></thead> <tbody><tr><td>经典模式</td> <td>即一主多从模式，安装 pika 实例维度，即 1 个 pika 实例的数据可以被多个从实例数据同步。</td></tr> <tr><td>分布式模式</td> <td>即用户的数据集合称为 table，将 table 切分成多个分片，每个分片称为 slot，对于某个 key 的数据是由哈希算法计算来决定属于哪个 slot，将所有 slots 及其副本按照一定策略分散到所有的 pika 实例中，每个 pika 实例有一部分的主 slot 和一部分从 slot，主从的维度为 slot。</td></tr></tbody></table> <p>官网原理图如下</p> <p>经典模式
<img src="/classic_framework.png" alt=""></p> <p>分布式模式<br> <img src="/distributed_framework.png" alt=""></p> <p>从原理图中，也可以清晰的看出经典模式以实例为维度，分布式模式以 slot 为维度。</p> <h2 id="pika-启动流程"><a href="#pika-启动流程" class="header-anchor">#</a> pika 启动流程</h2> <p>基于 pika-3.4.0 版本的代码结构，其中 pika 引用了四个第三方的库，分别如下：</p> <ol><li>Blackwidow，由 piak 自行维护的基于 rocksdb 的存储管理，所有 pika 的数据操作都会通过 blackwidow 的封装最终落入 rocksdb。</li> <li>Glog，日志库，用于 pika 项目输入不同等级的日志。</li> <li>Pink，由 pika 自行维护的事件驱动框架，封装了 redis 协议的解析分发功能，并提供回调函数进行处理。</li> <li>Slash，一些处理工具函数，例如同步的或者数据类型的工具函数。</li></ol> <p>启动流程中最主要的几个函数如下：</p> <div class="language-c++ extra-class"><pre class="language-text"><code>int main(int argc, char *argv[]) {
  ...
  LOG(INFO) &lt;&lt; &quot;Server at: &quot; &lt;&lt; path;
  g_pika_cmd_table_manager = new PikaCmdTableManager();
  g_pika_server = new PikaServer();
  g_pika_rm = new PikaReplicaManager();
  g_pika_proxy = new PikaProxy();

  if (g_pika_conf-&gt;daemonize()) {
    close_std();
  }

  g_pika_proxy-&gt;Start();
  g_pika_rm-&gt;Start();
  g_pika_server-&gt;Start();
  ...
}

</code></pre></div><p>分为四步，即首先初始化 cmd 的命令，然后初始化 PikaServer，接着初始化 PikaReplicaManager，最后初始化 PikaProxy，主要的启动函数就是如上几步，接着就继续分析一下。</p> <h2 id="pikaserver-功能"><a href="#pikaserver-功能" class="header-anchor">#</a> PikaServer 功能</h2> <div class="language-c++ extra-class"><pre class="language-text"><code>PikaServer::PikaServer() :
  exit_(false),
  slot_state_(INFREE),
  have_scheduled_crontask_(false),
  last_check_compact_time_({0, 0}),
  master_ip_(&quot;&quot;),
  master_port_(0),
  repl_state_(PIKA_REPL_NO_CONNECT),
  role_(PIKA_ROLE_SINGLE),
  last_meta_sync_timestamp_(0),
  first_meta_sync_(false),
  loop_partition_state_machine_(false),
  force_full_sync_(false),
  slowlog_entry_id_(0) {

  //Init server ip host
  if (!ServerInit()) {   // 初始化监听的端口和IP
    LOG(FATAL) &lt;&lt; &quot;ServerInit iotcl error&quot;;
  }

  ...
  InitBlackwidowOptions();   // 初始化Blackwidow的参数项，主要配置rocksdb的相关参数
	...

  // Create thread   根据配置来查看有多少的工作线程数
  worker_num_ = std::min(g_pika_conf-&gt;thread_num(),
                         PIKA_MAX_WORKER_THREAD_NUM);

  std::set&lt;std::string&gt; ips;
  if (g_pika_conf-&gt;network_interface().empty()) {
    ips.insert(&quot;0.0.0.0&quot;);
  } else {
    ips.insert(&quot;127.0.0.1&quot;);
    ips.insert(host_);
  }
  // We estimate the queue size    获取处理的队列的大小
  int worker_queue_limit = g_pika_conf-&gt;maxclients() / worker_num_ + 100;
  LOG(INFO) &lt;&lt; &quot;Worker queue limit is &quot; &lt;&lt; worker_queue_limit;
  pika_dispatch_thread_ = new PikaDispatchThread(ips, port_, worker_num_, 3000,
                                                 worker_queue_limit, g_pika_conf-&gt;max_conn_rbuf_size());     // 设置处理响应请求的线程池
  pika_monitor_thread_ = new PikaMonitorThread();   // 监控的线程池
  pika_rsync_service_ = new PikaRsyncService(g_pika_conf-&gt;db_sync_path(),
                                             g_pika_conf-&gt;port() + kPortShiftRSync);  // 同步的线程池
  pika_pubsub_thread_ = new pink::PubSubThread();   // 订阅发布处理线程
  pika_auxiliary_thread_ = new PikaAuxiliaryThread();   // 心跳辅助的状态改变处理线程

  pika_client_processor_ = new PikaClientProcessor(g_pika_conf-&gt;thread_pool_size(), 100000);   //  处理异步的task

  pthread_rwlock_init(&amp;state_protector_, NULL);
  pthread_rwlock_init(&amp;slowlog_protector_, NULL);
}
</code></pre></div><p>这其中初始化了大量的工作线程，来启动协同处理分别启动了 6 个不同的线程池或者线程来进行不同的处理工作。</p> <h2 id="pikadispatchthread"><a href="#pikadispatchthread" class="header-anchor">#</a> PikaDispatchThread</h2> <div class="language-c++ extra-class"><pre class="language-text"><code>PikaDispatchThread::PikaDispatchThread(std::set&lt;std::string&gt; &amp;ips, int port, int work_num,
                                       int cron_interval, int queue_limit, int max_conn_rbuf_size)
    : conn_factory_(max_conn_rbuf_size),
      handles_(this) {
  thread_rep_ = pink::NewDispatchThread(ips, port, work_num, &amp;conn_factory_,
                                        cron_interval, queue_limit, &amp;handles_);
  thread_rep_-&gt;set_thread_name(&quot;Dispatcher&quot;);
}

...
private:
  class ClientConnFactory : public pink::ConnFactory {
   public:
     explicit ClientConnFactory(int max_conn_rbuf_size)
         : max_conn_rbuf_size_(max_conn_rbuf_size) {
     }
     virtual std::shared_ptr&lt;pink::PinkConn&gt; NewPinkConn(
        int connfd,
        const std::string &amp;ip_port,
        pink::Thread* server_thread,
        void* worker_specific_data,
        pink::PinkEpoll* pink_epoll) const {
       return std::static_pointer_cast&lt;pink::PinkConn&gt;
         (std::make_shared&lt;PikaClientConn&gt;(connfd, ip_port, server_thread, pink_epoll, pink::HandleType::kAsynchronous, max_conn_rbuf_size_));
     }
   private:
     int max_conn_rbuf_size_;
    ...

	...
  extern ServerThread *NewDispatchThread(
    const std::set&lt;std::string&gt;&amp; ips, int port,
    int work_num, ConnFactory* conn_factory,
    int cron_interval, int queue_limit,
    const ServerHandle* handle) {
  return new DispatchThread(ips, port, work_num, conn_factory,
                            cron_interval, queue_limit, handle);
  ...

  ...
  DispatchThread::DispatchThread(const std::set&lt;std::string&gt;&amp; ips, int port,
                               int work_num, ConnFactory* conn_factory,
                               int cron_interval, int queue_limit,
                               const ServerHandle* handle)
      : ServerThread::ServerThread(ips, port, cron_interval, handle),
        last_thread_(0),
        work_num_(work_num),
        queue_limit_(queue_limit) {
  worker_thread_ = new WorkerThread*[work_num_];
  for (int i = 0; i &lt; work_num_; i++) {
    worker_thread_[i] = new WorkerThread(conn_factory, this, queue_limit, cron_interval); // 生成多个工作线程，工作线程进来的请求通过conn_factory来进行处理
  }
}

DispatchThread::~DispatchThread() {
  for (int i = 0; i &lt; work_num_; i++) {
    delete worker_thread_[i];
  }
  delete[] worker_thread_;
}

int DispatchThread::StartThread() {
  for (int i = 0; i &lt; work_num_; i++) { // 根据设置的工作线程的数量来进行处理
    int ret = handle_-&gt;CreateWorkerSpecificData(
        &amp;(worker_thread_[i]-&gt;private_data_));
    if (ret != 0) {
      return ret;
    }

    if (!thread_name().empty()) {
      worker_thread_[i]-&gt;set_thread_name(&quot;WorkerThread&quot;);
    }
    ret = worker_thread_[i]-&gt;StartThread();  // 开启每一个工作线程
    if (ret != 0) {
      return ret;
    }
  }
  return ServerThread::StartThread();
}
...
</code></pre></div><p>此时会使用 PikaDispatchThread 的工厂方法来处理新接入的连接，并且每一个新进来的请求通过 NewPinkConn 来进行初始化，并接入处理。其中 DispatchThread 就是位于 pink 的库中实现的方法其中 ServerThread 机会在初始化的过程中进行端口 IP 的监听，在事件响应之后就会调用 HandleNewConn 方法来处理新加入的连接信息，会在处理的过程中进行一个轮训的操作来分配到工作线程，在加入事件之后就会通过新生成一个 PikaClientConn 来进行事件处理，当 pink 中的 redisconn 解析到了完整的命令的时候就会调用 PikaClientConn 的 ProcessRedisCmds 方法来处理（中间的逻辑有点复杂大家有兴趣可以自行查找源码阅读一下）。</p> <div class="language-c++ extra-class"><pre class="language-text"><code>void PikaClientConn::ProcessRedisCmds(const std::vector&lt;pink::RedisCmdArgsType&gt;&amp; argvs, bool async, std::string* response) {
  if (async) {   // 是否是后台任务
    BgTaskArg* arg = new BgTaskArg();  // 新建一个后台任务
    arg-&gt;redis_cmds = argvs;
    arg-&gt;conn_ptr = std::dynamic_pointer_cast&lt;PikaClientConn&gt;(shared_from_this());
    g_pika_server-&gt;ScheduleClientPool(&amp;DoBackgroundTask, arg);  // 放入PikaClientProcessor的线程池来进行处理
    return;
  }
  BatchExecRedisCmd(argvs);  // 如果不是则调用响应的线程池直接处理
}

...
void PikaClientConn::BatchExecRedisCmd(const std::vector&lt;pink::RedisCmdArgsType&gt;&amp; argvs) {
  resp_num.store(argvs.size());
  for (size_t i = 0; i &lt; argvs.size(); ++i) {  // 根据解析的输入参数大小来处理
    std::shared_ptr&lt;std::string&gt; resp_ptr = std::make_shared&lt;std::string&gt;();
    resp_array.push_back(resp_ptr);
    ExecRedisCmd(argvs[i], resp_ptr);   // 处理对应的命令
  }
  TryWriteResp();
}
...
void PikaClientConn::ExecRedisCmd(const PikaCmdArgsType&amp; argv, std::shared_ptr&lt;std::string&gt; resp_ptr) {
  // get opt
  std::string opt = argv[0];
  slash::StringToLower(opt);
  if (opt == kClusterPrefix) {   // 检查是否是集群名称开头
    if (argv.size() &gt;= 2 ) {
      opt += argv[1];
      slash::StringToLower(opt);
    }
  }

  std::shared_ptr&lt;Cmd&gt; cmd_ptr = DoCmd(argv, opt, resp_ptr);  // 执行命令
  // level == 0 or (cmd error) or (is_read)
  if (g_pika_conf-&gt;consensus_level() == 0 || !cmd_ptr-&gt;res().ok() || !cmd_ptr-&gt;is_write()) {
    *resp_ptr = std::move(cmd_ptr-&gt;res().message());
    resp_num--;
  }
}
...

std::shared_ptr&lt;Cmd&gt; PikaClientConn::DoCmd(
    const PikaCmdArgsType&amp; argv,
    const std::string&amp; opt,
    std::shared_ptr&lt;std::string&gt; resp_ptr) {
  // Get command info
  std::shared_ptr&lt;Cmd&gt; c_ptr = g_pika_cmd_table_manager-&gt;GetCmd(opt);   // 从命令列表中查找命令
  if (!c_ptr) {
    std::shared_ptr&lt;Cmd&gt; tmp_ptr = std::make_shared&lt;DummyCmd&gt;(DummyCmd());
    tmp_ptr-&gt;res().SetRes(CmdRes::kErrOther,
        &quot;unknown or unsupported command \'&quot; + opt + &quot;\&quot;&quot;);
    return tmp_ptr;
  }
  c_ptr-&gt;SetConn(std::dynamic_pointer_cast&lt;PikaClientConn&gt;(shared_from_this()));
  c_ptr-&gt;SetResp(resp_ptr);

  // Check authed
  // AuthCmd will set stat_
  if (!auth_stat_.IsAuthed(c_ptr)) {   // 检查是否认证
    c_ptr-&gt;res().SetRes(CmdRes::kErrOther, &quot;NOAUTH Authentication required.&quot;);
    return c_ptr;
  }

  uint64_t start_us = 0;
  if (g_pika_conf-&gt;slowlog_slower_than() &gt;= 0) {
    start_us = slash::NowMicros();
  }

  bool is_monitoring = g_pika_server-&gt;HasMonitorClients();  // 是否是监控的客户端
  if (is_monitoring) {
    ProcessMonitor(argv);
  }

  // Initial
  c_ptr-&gt;Initial(argv, current_table_);  // 初始化命令信息
  if (!c_ptr-&gt;res().ok()) {
    return c_ptr;
  }

  g_pika_server-&gt;UpdateQueryNumAndExecCountTable(current_table_, opt, c_ptr-&gt;is_write());

  // PubSub connection
  // (P)SubscribeCmd will set is_pubsub_
  if (this-&gt;IsPubSub()) {
    if (opt != kCmdNameSubscribe &amp;&amp;
        opt != kCmdNameUnSubscribe &amp;&amp;
        opt != kCmdNamePing &amp;&amp;
        opt != kCmdNamePSubscribe &amp;&amp;
        opt != kCmdNamePUnSubscribe) {
      c_ptr-&gt;res().SetRes(CmdRes::kErrOther,
          &quot;only (P)SUBSCRIBE / (P)UNSUBSCRIBE / PING / QUIT allowed in this context&quot;);
      return c_ptr;
    }
  }

  if (g_pika_conf-&gt;consensus_level() != 0 &amp;&amp; c_ptr-&gt;is_write()) {
    c_ptr-&gt;SetStage(Cmd::kBinlogStage);
  }
  if (!g_pika_server-&gt;IsCommandSupport(opt)) {
    c_ptr-&gt;res().SetRes(CmdRes::kErrOther,
        &quot;This command is not supported in current configuration&quot;);
    return c_ptr;
  }

  if (!g_pika_server-&gt;IsTableExist(current_table_)) {
    c_ptr-&gt;res().SetRes(CmdRes::kErrOther, &quot;Table not found&quot;);
    return c_ptr;
  }

  // TODO: Consider special commands, like flushall, flushdb?
  if (c_ptr-&gt;is_write()) {
    if (g_pika_server-&gt;IsTableBinlogIoError(current_table_)) {
      c_ptr-&gt;res().SetRes(CmdRes::kErrOther, &quot;Writing binlog failed, maybe no space left on device&quot;);
      return c_ptr;
    }
    std::vector&lt;std::string&gt; cur_key = c_ptr-&gt;current_key();
    if (cur_key.empty()) {
      c_ptr-&gt;res().SetRes(CmdRes::kErrOther, &quot;Internal ERROR&quot;);
      return c_ptr;
    }
    if (g_pika_server-&gt;readonly(current_table_, cur_key.front())) {
      c_ptr-&gt;res().SetRes(CmdRes::kErrOther, &quot;Server in read-only&quot;);
      return c_ptr;
    }
    if (!g_pika_server-&gt;ConsensusCheck(current_table_, cur_key.front())) {
      c_ptr-&gt;res().SetRes(CmdRes::kErrOther, &quot;Consensus level not match&quot;);
    }
  }

  // Process Command   执行命令
  c_ptr-&gt;Execute();

  if (g_pika_conf-&gt;slowlog_slower_than() &gt;= 0) {
    ProcessSlowlog(argv, start_us);
  }
  if (g_pika_conf-&gt;consensus_level() != 0 &amp;&amp; c_ptr-&gt;is_write()) {
    c_ptr-&gt;SetStage(Cmd::kExecuteStage);
  }

  return c_ptr;
}
...
</code></pre></div><p>通过层层的调用关系最终调用到了 Cmd 类的 Do 方法，例如 SetCmd 的执行流程如下：</p> <div class="language-c++ extra-class"><pre class="language-text"><code>void SetCmd::Do(std::shared_ptr&lt;Partition&gt; partition) {
  rocksdb::Status s;
  int32_t res = 1;
  switch (condition_) {
    case SetCmd::kXX:
      s = partition-&gt;db()-&gt;Setxx(key_, value_, &amp;res, sec_);  // 通过db来设置key相关的信息
      break;
    case SetCmd::kNX:
      s = partition-&gt;db()-&gt;Setnx(key_, value_, &amp;res, sec_);
      break;
    case SetCmd::kVX:
      s = partition-&gt;db()-&gt;Setvx(key_, target_, value_, &amp;success_, sec_);
      break;
    case SetCmd::kEXORPX:
      s = partition-&gt;db()-&gt;Setex(key_, value_, sec_);
      break;
    default:
      s = partition-&gt;db()-&gt;Set(key_, value_);
      break;
  }

  if (s.ok() || s.IsNotFound()) {
    if (condition_ == SetCmd::kVX) {
      res_.AppendInteger(success_);
    } else {
      if (res == 1) {
        res_.SetRes(CmdRes::kOk);
      } else {
        res_.AppendArrayLen(-1);;
      }
    }
  } else {
    res_.SetRes(CmdRes::kErrOther, s.ToString());
  }
}
</code></pre></div><p>至此就是通过一个简单的 set 命令来进行的流程，当然中间省略了很多复杂的交互细节，并且跳过了 pink 库的一个处理流程，最终会回调在 pika 中的 ProcessRedisCmds 处理。</p> <h3 id="pikaclientprocessor"><a href="#pikaclientprocessor" class="header-anchor">#</a> PikaClientProcessor</h3> <div class="language-c++ extra-class"><pre class="language-text"><code>PikaClientProcessor::PikaClientProcessor(
    size_t worker_num, size_t max_queue_size, const std::string&amp; name_prefix) {
  pool_ = new pink::ThreadPool(
      worker_num, max_queue_size, name_prefix + &quot;Pool&quot;);   // 生成一个线程池
  for (size_t i = 0; i &lt; worker_num; ++i) {   			// 根据设置的线程池数量来初始化
    pink::BGThread* bg_thread = new pink::BGThread(max_queue_size);  // 初始化bg工作线程
    bg_threads_.push_back(bg_thread);         	// 保存每个线程
    bg_thread-&gt;set_thread_name(name_prefix + &quot;BgThread&quot;);
  }
}
</code></pre></div><p>主要是生成线程池来进行后台运行。在上一节中分析的 task 就是交给了 pool_线程池来进行数据的处理。一些协调数据同步的工作就交给了 bg_threads 线程池处理。</p> <p><img src="/pika_threads.png" alt=""></p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>本文主要简单的描述了有关 piak 的总体设计框架（参考官网架构），简单的通过 PikaServer 的启动过程来描述了一下基础的处理逻辑，因为这其中涉及到大量的细节故并没有详尽的去分析，并且也没有涉及到其他的功能比如 slot 的数据一致性保证等等细节，后续有继续再继续查阅相关内容。由于本人才疏学浅，如有错误请批评指正。</p></div></section> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/document/design/快照式备份.html" class="prev">
          快照式备份
        </a></span> <span class="next"><a href="/document/design/blackwidow存储引擎数据格式.html">
          旧存储结构
        </a></span></p></div> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-b57cc07c data-v-7dd95ae2><li class="level-2" data-v-b57cc07c><a href="/document/design/pika-NoSQL%E5%8E%9F%E7%90%86%E6%A6%82%E8%BF%B0.html#pika-设计" class="sidebar-link reco-side-pika-设计" data-v-b57cc07c>pika 设计</a></li><li class="level-2" data-v-b57cc07c><a href="/document/design/pika-NoSQL%E5%8E%9F%E7%90%86%E6%A6%82%E8%BF%B0.html#pika-启动流程" class="sidebar-link reco-side-pika-启动流程" data-v-b57cc07c>pika 启动流程</a></li><li class="level-2" data-v-b57cc07c><a href="/document/design/pika-NoSQL%E5%8E%9F%E7%90%86%E6%A6%82%E8%BF%B0.html#pikaserver-功能" class="sidebar-link reco-side-pikaserver-功能" data-v-b57cc07c>PikaServer 功能</a></li><li class="level-2" data-v-b57cc07c><a href="/document/design/pika-NoSQL%E5%8E%9F%E7%90%86%E6%A6%82%E8%BF%B0.html#pikadispatchthread" class="sidebar-link reco-side-pikadispatchthread" data-v-b57cc07c>PikaDispatchThread</a></li><li class="level-3" data-v-b57cc07c><a href="/document/design/pika-NoSQL%E5%8E%9F%E7%90%86%E6%A6%82%E8%BF%B0.html#pikaclientprocessor" class="sidebar-link reco-side-pikaclientprocessor" data-v-b57cc07c>PikaClientProcessor</a></li><li class="level-2" data-v-b57cc07c><a href="/document/design/pika-NoSQL%E5%8E%9F%E7%90%86%E6%A6%82%E8%BF%B0.html#总结" class="sidebar-link reco-side-总结" data-v-b57cc07c>总结</a></li></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/assets/js/app.32d1b42e.js" defer></script><script src="/assets/js/7.1224f65b.js" defer></script><script src="/assets/js/2.9fbd6685.js" defer></script><script src="/assets/js/1.77f24ecd.js" defer></script><script src="/assets/js/49.37fdc54d.js" defer></script>
  </body>
</html>
