<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>pika在codis中的探索 | Pika 文档</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/pika-logo-trans.png">
    <meta name="description" content=" ">
    
    <link rel="preload" href="/assets/css/0.styles.f6912c97.css" as="style"><link rel="preload" href="/assets/js/app.f4c49bff.js" as="script"><link rel="preload" href="/assets/js/7.1224f65b.js" as="script"><link rel="preload" href="/assets/js/2.9fbd6685.js" as="script"><link rel="preload" href="/assets/js/1.77f24ecd.js" as="script"><link rel="preload" href="/assets/js/51.367b8ed7.js" as="script"><link rel="prefetch" href="/assets/js/10.dfb0299a.js"><link rel="prefetch" href="/assets/js/11.479e3941.js"><link rel="prefetch" href="/assets/js/14.65104886.js"><link rel="prefetch" href="/assets/js/15.0fe19f29.js"><link rel="prefetch" href="/assets/js/16.3a98beb2.js"><link rel="prefetch" href="/assets/js/17.85dc844f.js"><link rel="prefetch" href="/assets/js/18.060d220d.js"><link rel="prefetch" href="/assets/js/19.77ed2e0b.js"><link rel="prefetch" href="/assets/js/20.1faabea6.js"><link rel="prefetch" href="/assets/js/21.4913a81b.js"><link rel="prefetch" href="/assets/js/22.ec2bffa8.js"><link rel="prefetch" href="/assets/js/23.77700c61.js"><link rel="prefetch" href="/assets/js/24.6badfe0e.js"><link rel="prefetch" href="/assets/js/25.bda1b3e1.js"><link rel="prefetch" href="/assets/js/26.06377f0d.js"><link rel="prefetch" href="/assets/js/27.86112ea9.js"><link rel="prefetch" href="/assets/js/28.be8ca15b.js"><link rel="prefetch" href="/assets/js/29.98f0eb72.js"><link rel="prefetch" href="/assets/js/3.50c72d76.js"><link rel="prefetch" href="/assets/js/30.4c7947d3.js"><link rel="prefetch" href="/assets/js/31.aa1f8d83.js"><link rel="prefetch" href="/assets/js/32.bac8f00d.js"><link rel="prefetch" href="/assets/js/33.cb9d2429.js"><link rel="prefetch" href="/assets/js/34.380ce34c.js"><link rel="prefetch" href="/assets/js/35.b5fcd8bd.js"><link rel="prefetch" href="/assets/js/36.34421d06.js"><link rel="prefetch" href="/assets/js/37.974c194a.js"><link rel="prefetch" href="/assets/js/38.2d40b9d6.js"><link rel="prefetch" href="/assets/js/39.5d62c31a.js"><link rel="prefetch" href="/assets/js/4.ab7c6b55.js"><link rel="prefetch" href="/assets/js/40.8eb7fa64.js"><link rel="prefetch" href="/assets/js/41.fbd626e2.js"><link rel="prefetch" href="/assets/js/42.a61eadfa.js"><link rel="prefetch" href="/assets/js/43.a632a507.js"><link rel="prefetch" href="/assets/js/44.f4ae27e8.js"><link rel="prefetch" href="/assets/js/45.0e21b553.js"><link rel="prefetch" href="/assets/js/46.f9d98439.js"><link rel="prefetch" href="/assets/js/47.e53fc68e.js"><link rel="prefetch" href="/assets/js/48.05b6338a.js"><link rel="prefetch" href="/assets/js/49.37fdc54d.js"><link rel="prefetch" href="/assets/js/5.8a3b91a7.js"><link rel="prefetch" href="/assets/js/50.52457c11.js"><link rel="prefetch" href="/assets/js/52.d853b4e0.js"><link rel="prefetch" href="/assets/js/53.2b0e710e.js"><link rel="prefetch" href="/assets/js/54.2dda43eb.js"><link rel="prefetch" href="/assets/js/55.e357ec1f.js"><link rel="prefetch" href="/assets/js/56.35e28277.js"><link rel="prefetch" href="/assets/js/57.712bde78.js"><link rel="prefetch" href="/assets/js/58.efe86a06.js"><link rel="prefetch" href="/assets/js/59.4223290f.js"><link rel="prefetch" href="/assets/js/6.2727d8db.js"><link rel="prefetch" href="/assets/js/60.52835ede.js"><link rel="prefetch" href="/assets/js/61.6dffea07.js"><link rel="prefetch" href="/assets/js/62.9121468e.js"><link rel="prefetch" href="/assets/js/63.55f28f07.js"><link rel="prefetch" href="/assets/js/64.bf9e1a4f.js"><link rel="prefetch" href="/assets/js/65.6994aa90.js"><link rel="prefetch" href="/assets/js/66.76eb1c15.js"><link rel="prefetch" href="/assets/js/67.f9241870.js"><link rel="prefetch" href="/assets/js/68.6e1e4216.js"><link rel="prefetch" href="/assets/js/69.442140c3.js"><link rel="prefetch" href="/assets/js/70.dc405d26.js"><link rel="prefetch" href="/assets/js/71.b2386ab3.js"><link rel="prefetch" href="/assets/js/72.eba4d61c.js"><link rel="prefetch" href="/assets/js/73.833b4b7a.js"><link rel="prefetch" href="/assets/js/74.24d21aeb.js"><link rel="prefetch" href="/assets/js/75.cbcf9227.js"><link rel="prefetch" href="/assets/js/76.e9ed2912.js"><link rel="prefetch" href="/assets/js/77.d8ed397f.js"><link rel="prefetch" href="/assets/js/78.96639754.js"><link rel="prefetch" href="/assets/js/79.79f3a85f.js"><link rel="prefetch" href="/assets/js/8.617b6635.js"><link rel="prefetch" href="/assets/js/80.ccf3c9fe.js"><link rel="prefetch" href="/assets/js/81.051f57a1.js"><link rel="prefetch" href="/assets/js/82.c775bb2e.js"><link rel="prefetch" href="/assets/js/83.dba45c87.js"><link rel="prefetch" href="/assets/js/84.5c7295ac.js"><link rel="prefetch" href="/assets/js/85.7f822be4.js"><link rel="prefetch" href="/assets/js/86.23e94d91.js"><link rel="prefetch" href="/assets/js/87.216ac4f8.js"><link rel="prefetch" href="/assets/js/88.1ffdea5b.js"><link rel="prefetch" href="/assets/js/89.02556523.js"><link rel="prefetch" href="/assets/js/9.cf1faa69.js"><link rel="prefetch" href="/assets/js/90.4d31e342.js"><link rel="prefetch" href="/assets/js/91.481ab8c6.js"><link rel="prefetch" href="/assets/js/92.c060cfb9.js"><link rel="prefetch" href="/assets/js/93.44ea7cfe.js"><link rel="prefetch" href="/assets/js/94.76ce1c72.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.c040f9c6.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f6912c97.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>Pika 文档</h3> <p class="description" data-v-59e6cb88> </p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>Pika</span>
          
        <span data-v-59e6cb88>2015 - </span>
        2024
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/pika-smalllogo.png" alt="Pika 文档" class="logo"> <span class="site-name">Pika 文档</span></a> <div class="links"><!----> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><a href="/document/Pika介绍.html" class="nav-link"><i class="undefined"></i>
  文档
</a></div><div class="nav-item"><a href="https://github.com/OpenAtomFoundation/pika" target="_blank" rel="noopener noreferrer" class="nav-link external"><i></i>
  文档仓库
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><!----> <h3 class="name" data-v-1fad0c41>
    Pika
  </h3> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>56</h3> <h6 data-v-1fad0c41>Articles</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>0</h3> <h6 data-v-1fad0c41>Tags</h6></div></div> <ul class="social-links" data-v-1fad0c41></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><a href="/document/Pika介绍.html" class="nav-link"><i class="undefined"></i>
  文档
</a></div><div class="nav-item"><a href="https://github.com/OpenAtomFoundation/pika" target="_blank" rel="noopener noreferrer" class="nav-link external"><i></i>
  文档仓库
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav> <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/document/Pika介绍" class="sidebar-heading clickable"><span>概况</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/document/Pika介绍.html" class="sidebar-link">Pika介绍</a></li><li><a href="/document/use/支持的语言和客户端.html" class="sidebar-link">支持的语言和客户端</a></li><li><a href="/document/use/当前支持的Redis接口以及兼容情况.html" class="sidebar-link">支持的Redis接口</a></li><li><a href="/document/FAQ.html" class="sidebar-link">FAQ</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/document/use/安装使用" class="sidebar-heading clickable"><span>使用与运维</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/document/use/安装使用.html" class="sidebar-link">安装使用</a></li><li><a href="/document/use/配置文件说明.html" class="sidebar-link">配置文件</a></li><li><a href="/document/use/数据目录说明.html" class="sidebar-link">数据目录</a></li><li><a href="/document/use/info信息说明.html" class="sidebar-link">info信息</a></li><li><a href="/document/use/部分管理指令说明.html" class="sidebar-link">管理指令</a></li><li><a href="/document/use/差异化命令.html" class="sidebar-link">差异化命令</a></li><li><a href="/document/use/Pika订阅.html" class="sidebar-link">Pika订阅</a></li><li><a href="/document/use/配合sentinel实现pika自动容灾.html" class="sidebar-link">自动容灾</a></li><li><a href="/document/use/Pika多库版命令.html" class="sidebar-link">多库版命令</a></li><li><a href="/document/use/Pika分片.html" class="sidebar-link">分片教程</a></li><li><a href="/document/use/副本一致性使用说明.html" class="sidebar-link">副本一致性</a></li><li><a href="/document/use/Pika最佳实践.html" class="sidebar-link">最佳实践</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/document/use/如何实现3.3.6升级到3.5.x" class="sidebar-heading clickable"><span>升级指南</span> <span class="arrow right"></span></a> <!----></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>性能与优化</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/document/performance/3.2.x性能.html" class="sidebar-link">3.2.x性能</a></li><li><a href="/document/use/Pika内存使用.html" class="sidebar-link">Pika内存使用</a></li><li><a href="/document/performance/Redis与Pikascan性能对比.html" class="sidebar-link">Redis 与 Pika scan 性能对比</a></li><li><a href="/document/performance/Pika3.5参数优化手册.html" class="sidebar-link">Pika 3.5 参数优化手册</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Pika 优化案例</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>设计与实现</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/document/design/整体架构.html" class="sidebar-link">整体架构</a></li><li><a href="/document/design/线程模型.html" class="sidebar-link">线程模型</a></li><li><a href="/document/design/锁的应用.html" class="sidebar-link">锁的应用</a></li><li><a href="/document/design/全同步.html" class="sidebar-link">全同步</a></li><li><a href="/document/design/增量同步.html" class="sidebar-link">增量同步</a></li><li><a href="/document/design/pika主从同步原理.html" class="sidebar-link">主从同步</a></li><li><a href="/document/design/副本一致性.html" class="sidebar-link">副本一致性</a></li><li><a href="/document/design/pika在codis中的探索.html" class="active sidebar-link">Pika 与 Codis</a></li><li><a href="/document/design/快照式备份.html" class="sidebar-link">快照式备份</a></li><li><a href="/document/design/pika-NoSQL原理概述.html" class="sidebar-link">NoSQL 实现</a></li><li><a href="/document/design/blackwidow存储引擎数据格式.html" class="sidebar-link">旧存储结构</a></li><li><a href="/document/design/Pika新存储结构Floyd.html" class="sidebar-link">新存储结构 Floyd</a></li><li><a href="/document/design/floyd存储方案.html" class="sidebar-link">Floyd 详解</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/document/design/Pika源码学习study1" class="sidebar-heading clickable"><span>Pika 源码学习</span> <span class="arrow right"></span></a> <!----></section></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/document/develop/Pikacodingstyle" class="sidebar-heading clickable"><span>开发文档</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/document/develop/Pikacodingstyle.html" class="sidebar-link">Pika 开发规范</a></li><li><a href="/document/develop/pikacode.html" class="sidebar-link">Pika 代码梳理</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/tool/3.2.新旧可读三类binlog转换工具" class="sidebar-heading clickable"><span>工具包</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/document/tool/3.2.新旧可读三类binlog转换工具.html" class="sidebar-link">3.2.新，旧，可读三类binlog转换工具</a></li><li><a href="/document/tool/根据时间戳恢复数据工具.html" class="sidebar-link">根据时间戳恢复数据工具</a></li><li><a href="/document/tool/Redis到Pika迁移工具.html" class="sidebar-link">Redis到Pika迁移工具</a></li><li><a href="/document/tool/Redis请求实时copy到Pika工具.html" class="sidebar-link">Redis请求实时copy到Pika工具</a></li><li><a href="/document/tool/Pikatool1.html" class="sidebar-link">Pika到Pika、Redis迁移工具 Pika-Port(适用于 Pika v2.x&amp;v3.0.x)</a></li><li><a href="/document/tool/Pikatool2.html" class="sidebar-link">Pika到Pika、Redis迁移工具 Pika-Migrage(适用于 Pika v3.2及以上版本)</a></li><li><a href="/document/tool/Pika的kv数据写入txt文本工具.html" class="sidebar-link">Pika的kv数据写入txt文本工具</a></li><li><a href="/document/tool/kv数据txt文本迁移Pika工具.html" class="sidebar-link">kv数据txt文本迁移Pika工具</a></li><li><a href="/document/tool/pikaexporter监控工具.html" class="sidebar-link">pika exporter监控工具</a></li><li><a href="/document/tool/codis-redis实时同步pika工具.html" class="sidebar-link">codis-redis实时同步pika工具</a></li></ul></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>pika在codis中的探索</h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>Pika</span>
          
        <span data-v-59e6cb88>2015 - </span>
        2024
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page" style="padding-right:0;"><section style="display:;"><div class="page-title"><h1 class="title">pika在codis中的探索</h1> <div data-v-8a445198><i class="iconfont reco-account" data-v-8a445198><span data-v-8a445198>Pika</span></i> <!----> <!----> <!----></div></div> <div class="theme-reco-content content__default"><h5 id="背景"><a href="#背景" class="header-anchor">#</a> 背景</h5> <p>面对kv类型数据在公司的存储量越来越大，以及在性能响应不敏感的情况下，利用原生的codis方案来存储数据的方案，成本也越来越高，在这种场景下，急需一种替代方案能够有效兼顾成本与性能。故引入了pika来作为codis的底层存储，来替换成本较高的codis-server，并围绕pika的方案进行了一系列的设计改造。</p> <h5 id="codis的原理设计"><a href="#codis的原理设计" class="header-anchor">#</a> codis的原理设计</h5> <p>codis项目主要分为codis-fe、codis-<a href="https://so.csdn.net/so/search?q=dashboard&amp;spm=1001.2101.3001.7020" target="_blank" rel="noopener noreferrer">dashboard<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、codis-proxy和codis-server这四个组件。</p> <p>codis-fe主要是方便统一管理多套的codis-dasbhoard，并提供运维友好的管理界面，在运维性与管理性上面都比较友好。</p> <p>codis-dashboard主要就是完成有关slot、codis-proxy和zk（或者<a href="https://so.csdn.net/so/search?q=etcd&amp;spm=1001.2101.3001.7020" target="_blank" rel="noopener noreferrer">etcd<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）等组件的数据一致性，整个集群的运维的状态，数据的扩容缩容和组件高可用的管理，类似于k8s的api-server的功能。</p> <p>codis-proxy主要就是提供给业务层面使用的访问代理，解析请求路由并将key的路由信息路由到对应的后端group上面，而且还有一个很重要的功能就是当通过codis-fe来进行集群的扩缩容的时候，codis-proxy会根据group的迁移状态，来触发key的检查或者迁移的功能从而完成在不中断业务服务的情况下热迁移数据，从而保证业务的可用性。</p> <h6 id="codis的运行原理"><a href="#codis的运行原理" class="header-anchor">#</a> codis的运行原理</h6> <p>codis在运行的过程中与官网给定的原理图是一致的。</p> <p><img src="https://img-blog.csdnimg.cn/0962ab74918247058d4deacad22c46e0.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5bCP5bGL5a2Q5aSn5L6g,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="在这里插入图片描述"></p> <p>通过zk的路径暴露，来进行codis-proxy的负载均衡和服务发现，可使用官方提供的jodis或者自己实现的redis-client来进行封装。</p> <p>codis-dashboard通过接受codis-fe的扩缩容、上下线，集群主从状态等管理指令。在接受到指令之后，通过将状态的存储并将状态推送到codis-proxy，从而使在codis-fe上线的管理能够动态的在codis-proxy的数据能够动态路由，所有的集群状态的管理都会通过codis-dashboard来保持一致。</p> <h6 id="codis的扩缩容原理"><a href="#codis的扩缩容原理" class="header-anchor">#</a> codis的扩缩容原理</h6> <p>通过对codis整个的运行图的简单的概述，我们来进一步探讨一下有关codis是如何进行一个动态的扩缩容的。</p> <p>以扩展group为例，整个的集群流程如下。</p> <p>原始集群如下，此时需要将group4加入集群，并将group3的901-1023的slot迁移到group4。</p> <p>​ <img src="https://img-blog.csdnimg.cn/b6b38324c03745fbb06bb160870bd3c5.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5bCP5bGL5a2Q5aSn5L6g,size_14,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="在这里插入图片描述"></p> <p>迁移完成之后的状态如下。</p> <p><img src="https://img-blog.csdnimg.cn/cc4cb340e53541e4b4485852cd1f6427.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5bCP5bGL5a2Q5aSn5L6g,size_18,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="在这里插入图片描述"></p> <p>此时group4就新加入到codis集群中，并运行的数据slot为原group3的901-1023的slot。</p> <p>详细的迁移步骤可以分为如下几步。</p> <h6 id="codis-fe将状态发往codis-dashboard"><a href="#codis-fe将状态发往codis-dashboard" class="header-anchor">#</a> codis-fe将状态发往codis-dashboard</h6> <p>在codis-fe上面，在Migrate Range上面将slot填写为901-1023，迁移至group4。</p> <p>此时codis-fe就会往codis-dashboard发送一个包含/api/topom/slots/action/create-range/…/901/1023/1的uri，此时codis-dashboard就会执行如下的操作。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>Topom<span class="token punctuation">)</span> <span class="token function">SlotCreateActionSome</span><span class="token punctuation">(</span>groupFrom<span class="token punctuation">,</span> groupTo <span class="token builtin">int</span><span class="token punctuation">,</span> numSlots <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	s<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> s<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	ctx<span class="token punctuation">,</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">newContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>

	g<span class="token punctuation">,</span> err <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">getGroup</span><span class="token punctuation">(</span>groupTo<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>g<span class="token punctuation">.</span>Servers<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;group-[%d] is empty&quot;</span><span class="token punctuation">,</span> g<span class="token punctuation">.</span>Id<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">var</span> pending <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> m <span class="token operator">:=</span> <span class="token keyword">range</span> ctx<span class="token punctuation">.</span>slots <span class="token punctuation">{</span>   <span class="token comment">// 验证slot的状态</span>
		<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>pending<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> numSlots <span class="token punctuation">{</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> m<span class="token punctuation">.</span>Action<span class="token punctuation">.</span>State <span class="token operator">!=</span> models<span class="token punctuation">.</span>ActionNothing <span class="token punctuation">{</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> m<span class="token punctuation">.</span>GroupId <span class="token operator">!=</span> groupFrom <span class="token punctuation">{</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> m<span class="token punctuation">.</span>GroupId <span class="token operator">==</span> g<span class="token punctuation">.</span>Id <span class="token punctuation">{</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>
		pending <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>pending<span class="token punctuation">,</span> m<span class="token punctuation">.</span>Id<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> sid <span class="token operator">:=</span> <span class="token keyword">range</span> pending <span class="token punctuation">{</span>
		m<span class="token punctuation">,</span> err <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">getSlotMapping</span><span class="token punctuation">(</span>sid<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> err
		<span class="token punctuation">}</span>
		<span class="token keyword">defer</span> s<span class="token punctuation">.</span><span class="token function">dirtySlotsCache</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>Id<span class="token punctuation">)</span>   <span class="token comment">// 将该slot标记为需要重新写入zk或者etcd来维持状态</span>

		m<span class="token punctuation">.</span>Action<span class="token punctuation">.</span>State <span class="token operator">=</span> models<span class="token punctuation">.</span>ActionPending
		m<span class="token punctuation">.</span>Action<span class="token punctuation">.</span>Index <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">maxSlotActionIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span>
		m<span class="token punctuation">.</span>Action<span class="token punctuation">.</span>TargetId <span class="token operator">=</span> g<span class="token punctuation">.</span>Id
		<span class="token keyword">if</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">storeUpdateSlotMapping</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>  <span class="token comment">// 更新该slot的状态，该结构维护了group到slot的对应的关系，用于在codis-proxy中就行每个slot的路由代理</span>
			<span class="token keyword">return</span> err
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre></div><p>从流程可知，创建迁移过程之后，其实就是将迁移的信息写入zk或者etcd中来保存迁移的状态，并且通过codis-dashboard自己启动的状态机来进行每一步的状态迁移。</p> <h6 id="codis-dashboard接受状态并开始启动迁移"><a href="#codis-dashboard接受状态并开始启动迁移" class="header-anchor">#</a> codis-dashboard接受状态并开始启动迁移</h6> <p>在codis-fe成功写入迁移信息到zk或者etcd之后，此时就通过codis-dashboard自身监控服务迁移的状态来启动数据迁移。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">//处理slot操作</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">for</span> <span class="token operator">!</span>s<span class="token punctuation">.</span><span class="token function">IsClosed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> s<span class="token punctuation">.</span><span class="token function">IsOnline</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">ProcessSlotAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
					log<span class="token punctuation">.</span><span class="token function">WarnErrorf</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">&quot;process slot action failed&quot;</span><span class="token punctuation">)</span>
					time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second <span class="token operator">*</span> <span class="token number">5</span><span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>该协程就会一直刷新查看是否有迁移的状态，如果有迁移的状态就会进行处理。有关对该状态处理的核心函数如下。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>Topom<span class="token punctuation">)</span> <span class="token function">SlotActionPrepareFilter</span><span class="token punctuation">(</span>accept<span class="token punctuation">,</span> update <span class="token keyword">func</span><span class="token punctuation">(</span>m <span class="token operator">*</span>models<span class="token punctuation">.</span>SlotMapping<span class="token punctuation">)</span> <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	s<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> s<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// 上下文</span>
	ctx<span class="token punctuation">,</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">newContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>

	<span class="token comment">// 取最小的action index</span>
	<span class="token keyword">var</span> minActionIndex <span class="token operator">=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>filter <span class="token keyword">func</span><span class="token punctuation">(</span>m <span class="token operator">*</span>models<span class="token punctuation">.</span>SlotMapping<span class="token punctuation">)</span> <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>picked <span class="token operator">*</span>models<span class="token punctuation">.</span>SlotMapping<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> m <span class="token operator">:=</span> <span class="token keyword">range</span> ctx<span class="token punctuation">.</span>slots <span class="token punctuation">{</span>
			<span class="token comment">// 遍历所有的slotMapping, 如果 m.Action.State == &quot;&quot;, 跳出本次循环, 执行下次循环</span>
			<span class="token keyword">if</span> m<span class="token punctuation">.</span>Action<span class="token punctuation">.</span>State <span class="token operator">==</span> models<span class="token punctuation">.</span>ActionNothing <span class="token punctuation">{</span>
				<span class="token keyword">continue</span>
			<span class="token punctuation">}</span>

			<span class="token comment">// 将slotMapping传入filter函数中, 如果m.Action.State != models.ActionPending, 才执行if里面的语句</span>
			<span class="token keyword">if</span> <span class="token function">filter</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span> picked <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> picked<span class="token punctuation">.</span>Action<span class="token punctuation">.</span>Index <span class="token operator">&lt;</span> m<span class="token punctuation">.</span>Action<span class="token punctuation">.</span>Index <span class="token punctuation">{</span>
					<span class="token keyword">continue</span>
				<span class="token punctuation">}</span>

				<span class="token comment">//只有一个slot没有执行过update方法,accept才会返回true;也就是说,一个slot只会被处理一次</span>
				<span class="token comment">// marks里面保存的是:已经分配了group,或者即将分配group,这2种group id</span>
				<span class="token comment">// 如果m的即将分配group id在marks里面, accept(m)就返回false, 这样就保证了同时只有一个slot迁入到同一个group下, 在一个redis下面,同时只有一个slot被迁移出去</span>
				<span class="token keyword">if</span> accept <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">||</span> <span class="token function">accept</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					picked <span class="token operator">=</span> m
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> picked
	<span class="token punctuation">}</span>

	<span class="token comment">// 第一种情况是: 取正在做slot迁移的slot里面action.id最小的那个slot</span>
	<span class="token comment">// 第二中情况是: 上面的没有取到的前提下,才做第二种操作,取出pending状态的slot里面action.id最小的那个slot</span>
	<span class="token keyword">var</span> m <span class="token operator">=</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>models<span class="token punctuation">.</span>SlotMapping <span class="token punctuation">{</span>
		<span class="token comment">// 取出 m.Action.State != &quot;&quot; and m.Action.State != pending 的slot里面action.id最小的那个slot</span>
		<span class="token comment">// 即: 取出正在做slot迁移的slot里面action.id最小的那个slot</span>
		<span class="token comment">// 赋值给picked</span>
		<span class="token comment">// 然后返回</span>
		<span class="token keyword">var</span> picked <span class="token operator">=</span> <span class="token function">minActionIndex</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>m <span class="token operator">*</span>models<span class="token punctuation">.</span>SlotMapping<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> m<span class="token punctuation">.</span>Action<span class="token punctuation">.</span>State <span class="token operator">!=</span> models<span class="token punctuation">.</span>ActionPending
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> picked <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> picked
		<span class="token punctuation">}</span>

		<span class="token comment">// 如果上面没有取到,执行下面的语句</span>

		<span class="token keyword">if</span> s<span class="token punctuation">.</span>action<span class="token punctuation">.</span>disabled<span class="token punctuation">.</span><span class="token function">IsTrue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// 取出 m.Action.State != &quot;&quot; and m.Action.State == models.ActionPending的slot里面action.id最小的那个slot</span>
		<span class="token comment">// 即: 取出pending状态的slot里面action.id最小的那个slot</span>
		<span class="token comment">// 赋值给picked</span>
		<span class="token comment">// 然后返回</span>
		<span class="token keyword">return</span> <span class="token function">minActionIndex</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>m <span class="token operator">*</span>models<span class="token punctuation">.</span>SlotMapping<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> m<span class="token punctuation">.</span>Action<span class="token punctuation">.</span>State <span class="token operator">==</span> models<span class="token punctuation">.</span>ActionPending
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// 上面2种情况都没有取到值的话,说明不需要做slot迁移, 因为没有取到正在做slot迁移的最小的action.id, 也没有取到准备做slot迁移的最小的action.id</span>
	<span class="token keyword">if</span> m <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>


	<span class="token keyword">if</span> update <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">update</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>

	log<span class="token punctuation">.</span><span class="token function">Warnf</span><span class="token punctuation">(</span><span class="token string">&quot;slot-[%d] action prepare:\n%s&quot;</span><span class="token punctuation">,</span> m<span class="token punctuation">.</span>Id<span class="token punctuation">,</span> m<span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


	<span class="token comment">//变更每个SlotMapping的action.state,并与zk交互</span>
	<span class="token comment">//另外,Action.state符合preparing或者prepared的时候,要将SlotMapping同步到proxy</span>
	<span class="token keyword">switch</span> m<span class="token punctuation">.</span>Action<span class="token punctuation">.</span>State <span class="token punctuation">{</span>

	<span class="token keyword">case</span> models<span class="token punctuation">.</span>ActionPending<span class="token punctuation">:</span>

		<span class="token keyword">defer</span> s<span class="token punctuation">.</span><span class="token function">dirtySlotsCache</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>Id<span class="token punctuation">)</span>

		<span class="token comment">// 将action state状态改成 preparing</span>
		m<span class="token punctuation">.</span>Action<span class="token punctuation">.</span>State <span class="token operator">=</span> models<span class="token punctuation">.</span>ActionPreparing

		<span class="token comment">// 写入zk中</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">storeUpdateSlotMapping</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> err
		<span class="token punctuation">}</span>

		<span class="token comment">// 无条件继续执行下面case中语句</span>
		<span class="token keyword">fallthrough</span>

	<span class="token keyword">case</span> models<span class="token punctuation">.</span>ActionPreparing<span class="token punctuation">:</span>

		<span class="token keyword">defer</span> s<span class="token punctuation">.</span><span class="token function">dirtySlotsCache</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>Id<span class="token punctuation">)</span>

		log<span class="token punctuation">.</span><span class="token function">Warnf</span><span class="token punctuation">(</span><span class="token string">&quot;slot-[%d] resync to prepared&quot;</span><span class="token punctuation">,</span> m<span class="token punctuation">.</span>Id<span class="token punctuation">)</span>

		<span class="token comment">// 将action state状态改成 ActionPrepared</span>
		m<span class="token punctuation">.</span>Action<span class="token punctuation">.</span>State <span class="token operator">=</span> models<span class="token punctuation">.</span>ActionPrepared

		<span class="token comment">// 将slotMapping信息刷新到proxy中, 如果刷失败了, 将m.Action.State改回ActionPreparing, 返回</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">resyncSlotMappings</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> m<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			log<span class="token punctuation">.</span><span class="token function">Warnf</span><span class="token punctuation">(</span><span class="token string">&quot;slot-[%d] resync-rollback to preparing&quot;</span><span class="token punctuation">,</span> m<span class="token punctuation">.</span>Id<span class="token punctuation">)</span>

			<span class="token comment">// slotMapping信息刷新到proxy失败, m.Action.State改回ActionPreparing</span>
			m<span class="token punctuation">.</span>Action<span class="token punctuation">.</span>State <span class="token operator">=</span> models<span class="token punctuation">.</span>ActionPreparing
			s<span class="token punctuation">.</span><span class="token function">resyncSlotMappings</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> m<span class="token punctuation">)</span>
			log<span class="token punctuation">.</span><span class="token function">Warnf</span><span class="token punctuation">(</span><span class="token string">&quot;slot-[%d] resync-rollback to preparing, done&quot;</span><span class="token punctuation">,</span> m<span class="token punctuation">.</span>Id<span class="token punctuation">)</span>
			<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> err
		<span class="token punctuation">}</span>

		<span class="token comment">// 刷新proxy信息成功后, 将m.Action.State = models.ActionPrepared写入到zk中</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">storeUpdateSlotMapping</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> err
		<span class="token punctuation">}</span>

		<span class="token comment">// 无条件继续执行下面case中语句</span>
		<span class="token keyword">fallthrough</span>

	<span class="token keyword">case</span> models<span class="token punctuation">.</span>ActionPrepared<span class="token punctuation">:</span>

		<span class="token keyword">defer</span> s<span class="token punctuation">.</span><span class="token function">dirtySlotsCache</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>Id<span class="token punctuation">)</span>

		log<span class="token punctuation">.</span><span class="token function">Warnf</span><span class="token punctuation">(</span><span class="token string">&quot;slot-[%d] resync to migrating&quot;</span><span class="token punctuation">,</span> m<span class="token punctuation">.</span>Id<span class="token punctuation">)</span>

		<span class="token comment">// 将action state状态改成 ActionMigrating</span>
		m<span class="token punctuation">.</span>Action<span class="token punctuation">.</span>State <span class="token operator">=</span> models<span class="token punctuation">.</span>ActionMigrating

		<span class="token comment">// 将slotMapping信息刷新到proxy中, 如果刷失败了, 返回</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">resyncSlotMappings</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> m<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			log<span class="token punctuation">.</span><span class="token function">Warnf</span><span class="token punctuation">(</span><span class="token string">&quot;slot-[%d] resync to migrating failed&quot;</span><span class="token punctuation">,</span> m<span class="token punctuation">.</span>Id<span class="token punctuation">)</span>
			<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> err
		<span class="token punctuation">}</span>

		<span class="token comment">// 刷成功后, 将m.Action.State = models.ActionMigrating 写入zk</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">storeUpdateSlotMapping</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> err
		<span class="token punctuation">}</span>

		<span class="token comment">// 无条件继续执行下面case中语句</span>
		<span class="token keyword">fallthrough</span>

	<span class="token keyword">case</span> models<span class="token punctuation">.</span>ActionMigrating<span class="token punctuation">:</span>

		<span class="token keyword">return</span> m<span class="token punctuation">.</span>Id<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>

	<span class="token keyword">case</span> models<span class="token punctuation">.</span>ActionFinished<span class="token punctuation">:</span>

		<span class="token keyword">return</span> m<span class="token punctuation">.</span>Id<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>

	<span class="token keyword">default</span><span class="token punctuation">:</span>

		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;slot-[%d] action state is invalid&quot;</span><span class="token punctuation">,</span> m<span class="token punctuation">.</span>Id<span class="token punctuation">)</span>

	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在ActionPreparing的状态的时候，就会将数据写入zk或者etcd从而通知到了codis-proxy状态更新。</p> <p>在codis-dashboard中就会通过processSlotAction函数来进行后端数据的迁移，其中最核心的函数为newSlotActionExecutor。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// 调用redis的SLOTSMGRTTAGSLOT命令, 进行redis slot 迁移</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>Topom<span class="token punctuation">)</span> <span class="token function">newSlotActionExecutor</span><span class="token punctuation">(</span>sid <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>db <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>remains <span class="token builtin">int</span><span class="token punctuation">,</span> nextdb <span class="token builtin">int</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	s<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> s<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// 上下文</span>
	ctx<span class="token punctuation">,</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">newContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>

	<span class="token comment">//根据slot的id获取SlotMapping,主要方法就是return ctx.slots[sid], nil</span>
	m<span class="token punctuation">,</span> err <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">getSlotMapping</span><span class="token punctuation">(</span>sid<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>

	<span class="token keyword">switch</span> m<span class="token punctuation">.</span>Action<span class="token punctuation">.</span>State <span class="token punctuation">{</span>

	<span class="token comment">//最初slot还处在迁移过程中,即migrating</span>
	<span class="token keyword">case</span> models<span class="token punctuation">.</span>ActionMigrating<span class="token punctuation">:</span>

		<span class="token keyword">if</span> s<span class="token punctuation">.</span>action<span class="token punctuation">.</span>disabled<span class="token punctuation">.</span><span class="token function">IsTrue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// m.groupId 主从在切换时, 不做slot迁移操作</span>
		<span class="token keyword">if</span> ctx<span class="token punctuation">.</span><span class="token function">isGroupPromoting</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>GroupId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// m.action.targetId 主从在切换时, 不做slot迁移操作</span>
		<span class="token keyword">if</span> ctx<span class="token punctuation">.</span><span class="token function">isGroupPromoting</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>Action<span class="token punctuation">.</span>TargetId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
		<span class="token punctuation">}</span>

		<span class="token comment">//迁移过程中,一个slot本身所在的group以及目标group的Promoting.State都必须为空才可以做迁移</span>
		from <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">getGroupMaster</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>GroupId<span class="token punctuation">)</span>
		<span class="token comment">//取出group 2的第一个server,也是master</span>
		dest <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">getGroupMaster</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>Action<span class="token punctuation">.</span>TargetId<span class="token punctuation">)</span>

		<span class="token comment">//Topom的action中的计数器加一</span>
		s<span class="token punctuation">.</span>action<span class="token punctuation">.</span>executor<span class="token punctuation">.</span><span class="token function">Incr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

		<span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>db <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">//每执行一个槽的迁移操作,Topom的action中的计数器就减1</span>
			<span class="token keyword">defer</span> s<span class="token punctuation">.</span>action<span class="token punctuation">.</span>executor<span class="token punctuation">.</span><span class="token function">Decr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

			<span class="token keyword">if</span> from <span class="token operator">==</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
			<span class="token punctuation">}</span>

			<span class="token comment">//从cache中得到group 1的redisClient,这个client由addr, auth, timeout，Database，redigo.Conn组成: 如果cache没有, 就新建</span>
			c<span class="token punctuation">,</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span>action<span class="token punctuation">.</span>redisp<span class="token punctuation">.</span><span class="token function">GetClient</span><span class="token punctuation">(</span>from<span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> err
			<span class="token punctuation">}</span>
			<span class="token comment">//将刚才新建的或者从cache中取出的redis client再put到Topom.action.redisp中</span>
			<span class="token keyword">defer</span> s<span class="token punctuation">.</span>action<span class="token punctuation">.</span>redisp<span class="token punctuation">.</span><span class="token function">PutClient</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>

			<span class="token comment">//这里db是0,相当于redis从16个库中选择0号</span>
			<span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> err
			<span class="token punctuation">}</span>

			<span class="token keyword">var</span> do <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>

			method<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> models<span class="token punctuation">.</span><span class="token function">ParseForwardMethod</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>config<span class="token punctuation">.</span>MigrationMethod<span class="token punctuation">)</span>
			<span class="token keyword">switch</span> method <span class="token punctuation">{</span>
			<span class="token keyword">case</span> models<span class="token punctuation">.</span>ForwardSync<span class="token punctuation">:</span>
				do <span class="token operator">=</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token comment">//调用redis的SLOTSMGRTTAGSLOT命令,随机选择当前slot的一个key,并将与这个key的tag相同的k-v全部迁移到目标机</span>
					<span class="token keyword">return</span> c<span class="token punctuation">.</span><span class="token function">MigrateSlot</span><span class="token punctuation">(</span>sid<span class="token punctuation">,</span> dest<span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
			<span class="token keyword">case</span> models<span class="token punctuation">.</span>ForwardSemiAsync<span class="token punctuation">:</span>
				<span class="token keyword">var</span> option <span class="token operator">=</span> <span class="token operator">&amp;</span>redis<span class="token punctuation">.</span>MigrateSlotAsyncOption<span class="token punctuation">{</span>
					MaxBulks<span class="token punctuation">:</span> s<span class="token punctuation">.</span>config<span class="token punctuation">.</span>MigrationAsyncMaxBulks<span class="token punctuation">,</span>
					MaxBytes<span class="token punctuation">:</span> s<span class="token punctuation">.</span>config<span class="token punctuation">.</span>MigrationAsyncMaxBytes<span class="token punctuation">.</span><span class="token function">AsInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
					NumKeys<span class="token punctuation">:</span>  s<span class="token punctuation">.</span>config<span class="token punctuation">.</span>MigrationAsyncNumKeys<span class="token punctuation">,</span>
					Timeout<span class="token punctuation">:</span> math2<span class="token punctuation">.</span><span class="token function">MinDuration</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token operator">*</span><span class="token number">5</span><span class="token punctuation">,</span>
						s<span class="token punctuation">.</span>config<span class="token punctuation">.</span>MigrationTimeout<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
				<span class="token punctuation">}</span>
				<span class="token comment">//调用redis的SLOTSMGRTTAGSLOT-ASYNC命令,参数是target redis的ip和port</span>
				do <span class="token operator">=</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token keyword">return</span> c<span class="token punctuation">.</span><span class="token function">MigrateSlotAsync</span><span class="token punctuation">(</span>sid<span class="token punctuation">,</span> dest<span class="token punctuation">,</span> option<span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
			<span class="token keyword">default</span><span class="token punctuation">:</span>
				log<span class="token punctuation">.</span><span class="token function">Panicf</span><span class="token punctuation">(</span><span class="token string">&quot;unknown forward method %d&quot;</span><span class="token punctuation">,</span> <span class="token function">int</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>

			n<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">do</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> err
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> n <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> n<span class="token punctuation">,</span> db<span class="token punctuation">,</span> <span class="token boolean">nil</span>
			<span class="token punctuation">}</span>

			nextdb <span class="token operator">:=</span> <span class="token operator">-</span><span class="token number">1</span>
			<span class="token comment">//通过info命令查keyspace信息并做处理,这里取出的m为空</span>
			m<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">InfoKeySpace</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> err
			<span class="token punctuation">}</span>
			<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> m <span class="token punctuation">{</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>nextdb <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> i <span class="token operator">&lt;</span> nextdb<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> db <span class="token operator">&lt;</span> i <span class="token punctuation">{</span>
					nextdb <span class="token operator">=</span> i
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">,</span> nextdb<span class="token punctuation">,</span> <span class="token boolean">nil</span>

		<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>

	<span class="token keyword">case</span> models<span class="token punctuation">.</span>ActionFinished<span class="token punctuation">:</span>

		<span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>

	<span class="token keyword">default</span><span class="token punctuation">:</span>

		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;slot-[%d] action state is invalid&quot;</span><span class="token punctuation">,</span> m<span class="token punctuation">.</span>Id<span class="token punctuation">)</span>

	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>通过调用需要迁移数据的codis-server来主动进行数据的同步信息。</p> <p>如果在数据同步中，通过codis-proxy来访问数据，codis-proxy则根据配置文件要么去查找一下新节点数据是否存在，如果不存在则将数据迁移至新节点上面来从而保持数据的一致性。</p> <h6 id="codis-dashboard完成"><a href="#codis-dashboard完成" class="header-anchor">#</a> codis-dashboard完成</h6> <p>当所有的slot迁移完成之后，就会在zk或者etcd中更新当前的slot状态，从而完成整个迁移过程。</p> <p>整个迁移流程可简单如下所示。</p> <p>#mermaid-svg-h1GWqEQWEEE6LXij .label{font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family);fill:#333;color:#333}#mermaid-svg-h1GWqEQWEEE6LXij .label text{fill:#333}#mermaid-svg-h1GWqEQWEEE6LXij .node rect,#mermaid-svg-h1GWqEQWEEE6LXij .node circle,#mermaid-svg-h1GWqEQWEEE6LXij .node ellipse,#mermaid-svg-h1GWqEQWEEE6LXij .node polygon,#mermaid-svg-h1GWqEQWEEE6LXij .node path{fill:#ECECFF;stroke:#9370db;stroke-width:1px}#mermaid-svg-h1GWqEQWEEE6LXij .node .label{text-align:center;fill:#333}#mermaid-svg-h1GWqEQWEEE6LXij .node.clickable{cursor:pointer}#mermaid-svg-h1GWqEQWEEE6LXij .arrowheadPath{fill:#333}#mermaid-svg-h1GWqEQWEEE6LXij .edgePath .path{stroke:#333;stroke-width:1.5px}#mermaid-svg-h1GWqEQWEEE6LXij .flowchart-link{stroke:#333;fill:none}#mermaid-svg-h1GWqEQWEEE6LXij .edgeLabel{background-color:#e8e8e8;text-align:center}#mermaid-svg-h1GWqEQWEEE6LXij .edgeLabel rect{opacity:0.9}#mermaid-svg-h1GWqEQWEEE6LXij .edgeLabel span{color:#333}#mermaid-svg-h1GWqEQWEEE6LXij .cluster rect{fill:#ffffde;stroke:#aa3;stroke-width:1px}#mermaid-svg-h1GWqEQWEEE6LXij .cluster text{fill:#333}#mermaid-svg-h1GWqEQWEEE6LXij div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family);font-size:12px;background:#ffffde;border:1px solid #aa3;border-radius:2px;pointer-events:none;z-index:100}#mermaid-svg-h1GWqEQWEEE6LXij .actor{stroke:#ccf;fill:#ECECFF}#mermaid-svg-h1GWqEQWEEE6LXij text.actor&gt;tspan{fill:#000;stroke:none}#mermaid-svg-h1GWqEQWEEE6LXij .actor-line{stroke:grey}#mermaid-svg-h1GWqEQWEEE6LXij .messageLine0{stroke-width:1.5;stroke-dasharray:none;stroke:#333}#mermaid-svg-h1GWqEQWEEE6LXij .messageLine1{stroke-width:1.5;stroke-dasharray:2, 2;stroke:#333}#mermaid-svg-h1GWqEQWEEE6LXij #arrowhead path{fill:#333;stroke:#333}#mermaid-svg-h1GWqEQWEEE6LXij .sequenceNumber{fill:#fff}#mermaid-svg-h1GWqEQWEEE6LXij #sequencenumber{fill:#333}#mermaid-svg-h1GWqEQWEEE6LXij #crosshead path{fill:#333;stroke:#333}#mermaid-svg-h1GWqEQWEEE6LXij .messageText{fill:#333;stroke:#333}#mermaid-svg-h1GWqEQWEEE6LXij .labelBox{stroke:#ccf;fill:#ECECFF}#mermaid-svg-h1GWqEQWEEE6LXij .labelText,#mermaid-svg-h1GWqEQWEEE6LXij .labelText&gt;tspan{fill:#000;stroke:none}#mermaid-svg-h1GWqEQWEEE6LXij .loopText,#mermaid-svg-h1GWqEQWEEE6LXij .loopText&gt;tspan{fill:#000;stroke:none}#mermaid-svg-h1GWqEQWEEE6LXij .loopLine{stroke-width:2px;stroke-dasharray:2, 2;stroke:#ccf;fill:#ccf}#mermaid-svg-h1GWqEQWEEE6LXij .note{stroke:#aa3;fill:#fff5ad}#mermaid-svg-h1GWqEQWEEE6LXij .noteText,#mermaid-svg-h1GWqEQWEEE6LXij .noteText&gt;tspan{fill:#000;stroke:none}#mermaid-svg-h1GWqEQWEEE6LXij .activation0{fill:#f4f4f4;stroke:#666}#mermaid-svg-h1GWqEQWEEE6LXij .activation1{fill:#f4f4f4;stroke:#666}#mermaid-svg-h1GWqEQWEEE6LXij .activation2{fill:#f4f4f4;stroke:#666}#mermaid-svg-h1GWqEQWEEE6LXij .mermaid-main-font{font-family:&quot;trebuchet ms&quot;, verdana, arial;font-family:var(--mermaid-font-family)}#mermaid-svg-h1GWqEQWEEE6LXij .section{stroke:none;opacity:0.2}#mermaid-svg-h1GWqEQWEEE6LXij .section0{fill:rgba(102,102,255,0.49)}#mermaid-svg-h1GWqEQWEEE6LXij .section2{fill:#fff400}#mermaid-svg-h1GWqEQWEEE6LXij .section1,#mermaid-svg-h1GWqEQWEEE6LXij .section3{fill:#fff;opacity:0.2}#mermaid-svg-h1GWqEQWEEE6LXij .sectionTitle0{fill:#333}#mermaid-svg-h1GWqEQWEEE6LXij .sectionTitle1{fill:#333}#mermaid-svg-h1GWqEQWEEE6LXij .sectionTitle2{fill:#333}#mermaid-svg-h1GWqEQWEEE6LXij .sectionTitle3{fill:#333}#mermaid-svg-h1GWqEQWEEE6LXij .sectionTitle{text-anchor:start;font-size:11px;text-height:14px;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family)}#mermaid-svg-h1GWqEQWEEE6LXij .grid .tick{stroke:#d3d3d3;opacity:0.8;shape-rendering:crispEdges}#mermaid-svg-h1GWqEQWEEE6LXij .grid .tick text{font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family)}#mermaid-svg-h1GWqEQWEEE6LXij .grid path{stroke-width:0}#mermaid-svg-h1GWqEQWEEE6LXij .today{fill:none;stroke:red;stroke-width:2px}#mermaid-svg-h1GWqEQWEEE6LXij .task{stroke-width:2}#mermaid-svg-h1GWqEQWEEE6LXij .taskText{text-anchor:middle;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family)}#mermaid-svg-h1GWqEQWEEE6LXij .taskText:not([font-size]){font-size:11px}#mermaid-svg-h1GWqEQWEEE6LXij .taskTextOutsideRight{fill:#000;text-anchor:start;font-size:11px;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family)}#mermaid-svg-h1GWqEQWEEE6LXij .taskTextOutsideLeft{fill:#000;text-anchor:end;font-size:11px}#mermaid-svg-h1GWqEQWEEE6LXij .task.clickable{cursor:pointer}#mermaid-svg-h1GWqEQWEEE6LXij .taskText.clickable{cursor:pointer;fill:#003163 !important;font-weight:bold}#mermaid-svg-h1GWqEQWEEE6LXij .taskTextOutsideLeft.clickable{cursor:pointer;fill:#003163 !important;font-weight:bold}#mermaid-svg-h1GWqEQWEEE6LXij .taskTextOutsideRight.clickable{cursor:pointer;fill:#003163 !important;font-weight:bold}#mermaid-svg-h1GWqEQWEEE6LXij .taskText0,#mermaid-svg-h1GWqEQWEEE6LXij .taskText1,#mermaid-svg-h1GWqEQWEEE6LXij .taskText2,#mermaid-svg-h1GWqEQWEEE6LXij .taskText3{fill:#fff}#mermaid-svg-h1GWqEQWEEE6LXij .task0,#mermaid-svg-h1GWqEQWEEE6LXij .task1,#mermaid-svg-h1GWqEQWEEE6LXij .task2,#mermaid-svg-h1GWqEQWEEE6LXij .task3{fill:#8a90dd;stroke:#534fbc}#mermaid-svg-h1GWqEQWEEE6LXij .taskTextOutside0,#mermaid-svg-h1GWqEQWEEE6LXij .taskTextOutside2{fill:#000}#mermaid-svg-h1GWqEQWEEE6LXij .taskTextOutside1,#mermaid-svg-h1GWqEQWEEE6LXij .taskTextOutside3{fill:#000}#mermaid-svg-h1GWqEQWEEE6LXij .active0,#mermaid-svg-h1GWqEQWEEE6LXij .active1,#mermaid-svg-h1GWqEQWEEE6LXij .active2,#mermaid-svg-h1GWqEQWEEE6LXij .active3{fill:#bfc7ff;stroke:#534fbc}#mermaid-svg-h1GWqEQWEEE6LXij .activeText0,#mermaid-svg-h1GWqEQWEEE6LXij .activeText1,#mermaid-svg-h1GWqEQWEEE6LXij .activeText2,#mermaid-svg-h1GWqEQWEEE6LXij .activeText3{fill:#000 !important}#mermaid-svg-h1GWqEQWEEE6LXij .done0,#mermaid-svg-h1GWqEQWEEE6LXij .done1,#mermaid-svg-h1GWqEQWEEE6LXij .done2,#mermaid-svg-h1GWqEQWEEE6LXij .done3{stroke:grey;fill:#d3d3d3;stroke-width:2}#mermaid-svg-h1GWqEQWEEE6LXij .doneText0,#mermaid-svg-h1GWqEQWEEE6LXij .doneText1,#mermaid-svg-h1GWqEQWEEE6LXij .doneText2,#mermaid-svg-h1GWqEQWEEE6LXij .doneText3{fill:#000 !important}#mermaid-svg-h1GWqEQWEEE6LXij .crit0,#mermaid-svg-h1GWqEQWEEE6LXij .crit1,#mermaid-svg-h1GWqEQWEEE6LXij .crit2,#mermaid-svg-h1GWqEQWEEE6LXij .crit3{stroke:#f88;fill:red;stroke-width:2}#mermaid-svg-h1GWqEQWEEE6LXij .activeCrit0,#mermaid-svg-h1GWqEQWEEE6LXij .activeCrit1,#mermaid-svg-h1GWqEQWEEE6LXij .activeCrit2,#mermaid-svg-h1GWqEQWEEE6LXij .activeCrit3{stroke:#f88;fill:#bfc7ff;stroke-width:2}#mermaid-svg-h1GWqEQWEEE6LXij .doneCrit0,#mermaid-svg-h1GWqEQWEEE6LXij .doneCrit1,#mermaid-svg-h1GWqEQWEEE6LXij .doneCrit2,#mermaid-svg-h1GWqEQWEEE6LXij .doneCrit3{stroke:#f88;fill:#d3d3d3;stroke-width:2;cursor:pointer;shape-rendering:crispEdges}#mermaid-svg-h1GWqEQWEEE6LXij .milestone{transform:rotate(45deg) scale(0.8, 0.8)}#mermaid-svg-h1GWqEQWEEE6LXij .milestoneText{font-style:italic}#mermaid-svg-h1GWqEQWEEE6LXij .doneCritText0,#mermaid-svg-h1GWqEQWEEE6LXij .doneCritText1,#mermaid-svg-h1GWqEQWEEE6LXij .doneCritText2,#mermaid-svg-h1GWqEQWEEE6LXij .doneCritText3{fill:#000 !important}#mermaid-svg-h1GWqEQWEEE6LXij .activeCritText0,#mermaid-svg-h1GWqEQWEEE6LXij .activeCritText1,#mermaid-svg-h1GWqEQWEEE6LXij .activeCritText2,#mermaid-svg-h1GWqEQWEEE6LXij .activeCritText3{fill:#000 !important}#mermaid-svg-h1GWqEQWEEE6LXij .titleText{text-anchor:middle;font-size:18px;fill:#000;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family)}#mermaid-svg-h1GWqEQWEEE6LXij g.classGroup text{fill:#9370db;stroke:none;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family);font-size:10px}#mermaid-svg-h1GWqEQWEEE6LXij g.classGroup text .title{font-weight:bolder}#mermaid-svg-h1GWqEQWEEE6LXij g.clickable{cursor:pointer}#mermaid-svg-h1GWqEQWEEE6LXij g.classGroup rect{fill:#ECECFF;stroke:#9370db}#mermaid-svg-h1GWqEQWEEE6LXij g.classGroup line{stroke:#9370db;stroke-width:1}#mermaid-svg-h1GWqEQWEEE6LXij .classLabel .box{stroke:none;stroke-width:0;fill:#ECECFF;opacity:0.5}#mermaid-svg-h1GWqEQWEEE6LXij .classLabel .label{fill:#9370db;font-size:10px}#mermaid-svg-h1GWqEQWEEE6LXij .relation{stroke:#9370db;stroke-width:1;fill:none}#mermaid-svg-h1GWqEQWEEE6LXij .dashed-line{stroke-dasharray:3}#mermaid-svg-h1GWqEQWEEE6LXij #compositionStart{fill:#9370db;stroke:#9370db;stroke-width:1}#mermaid-svg-h1GWqEQWEEE6LXij #compositionEnd{fill:#9370db;stroke:#9370db;stroke-width:1}#mermaid-svg-h1GWqEQWEEE6LXij #aggregationStart{fill:#ECECFF;stroke:#9370db;stroke-width:1}#mermaid-svg-h1GWqEQWEEE6LXij #aggregationEnd{fill:#ECECFF;stroke:#9370db;stroke-width:1}#mermaid-svg-h1GWqEQWEEE6LXij #dependencyStart{fill:#9370db;stroke:#9370db;stroke-width:1}#mermaid-svg-h1GWqEQWEEE6LXij #dependencyEnd{fill:#9370db;stroke:#9370db;stroke-width:1}#mermaid-svg-h1GWqEQWEEE6LXij #extensionStart{fill:#9370db;stroke:#9370db;stroke-width:1}#mermaid-svg-h1GWqEQWEEE6LXij #extensionEnd{fill:#9370db;stroke:#9370db;stroke-width:1}#mermaid-svg-h1GWqEQWEEE6LXij .commit-id,#mermaid-svg-h1GWqEQWEEE6LXij .commit-msg,#mermaid-svg-h1GWqEQWEEE6LXij .branch-label{fill:lightgrey;color:lightgrey;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family)}#mermaid-svg-h1GWqEQWEEE6LXij .pieTitleText{text-anchor:middle;font-size:25px;fill:#000;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family)}#mermaid-svg-h1GWqEQWEEE6LXij .slice{font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family)}#mermaid-svg-h1GWqEQWEEE6LXij g.stateGroup text{fill:#9370db;stroke:none;font-size:10px;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family)}#mermaid-svg-h1GWqEQWEEE6LXij g.stateGroup text{fill:#9370db;fill:#333;stroke:none;font-size:10px}#mermaid-svg-h1GWqEQWEEE6LXij g.statediagram-cluster .cluster-label text{fill:#333}#mermaid-svg-h1GWqEQWEEE6LXij g.stateGroup .state-title{font-weight:bolder;fill:#000}#mermaid-svg-h1GWqEQWEEE6LXij g.stateGroup rect{fill:#ECECFF;stroke:#9370db}#mermaid-svg-h1GWqEQWEEE6LXij g.stateGroup line{stroke:#9370db;stroke-width:1}#mermaid-svg-h1GWqEQWEEE6LXij .transition{stroke:#9370db;stroke-width:1;fill:none}#mermaid-svg-h1GWqEQWEEE6LXij .stateGroup .composit{fill:white;border-bottom:1px}#mermaid-svg-h1GWqEQWEEE6LXij .stateGroup .alt-composit{fill:#e0e0e0;border-bottom:1px}#mermaid-svg-h1GWqEQWEEE6LXij .state-note{stroke:#aa3;fill:#fff5ad}#mermaid-svg-h1GWqEQWEEE6LXij .state-note text{fill:black;stroke:none;font-size:10px}#mermaid-svg-h1GWqEQWEEE6LXij .stateLabel .box{stroke:none;stroke-width:0;fill:#ECECFF;opacity:0.7}#mermaid-svg-h1GWqEQWEEE6LXij .edgeLabel text{fill:#333}#mermaid-svg-h1GWqEQWEEE6LXij .stateLabel text{fill:#000;font-size:10px;font-weight:bold;font-family:'trebuchet ms', verdana, arial;font-family:var(--mermaid-font-family)}#mermaid-svg-h1GWqEQWEEE6LXij .node circle.state-start{fill:black;stroke:black}#mermaid-svg-h1GWqEQWEEE6LXij .node circle.state-end{fill:black;stroke:white;stroke-width:1.5}#mermaid-svg-h1GWqEQWEEE6LXij #statediagram-barbEnd{fill:#9370db}#mermaid-svg-h1GWqEQWEEE6LXij .statediagram-cluster rect{fill:#ECECFF;stroke:#9370db;stroke-width:1px}#mermaid-svg-h1GWqEQWEEE6LXij .statediagram-cluster rect.outer{rx:5px;ry:5px}#mermaid-svg-h1GWqEQWEEE6LXij .statediagram-state .divider{stroke:#9370db}#mermaid-svg-h1GWqEQWEEE6LXij .statediagram-state .title-state{rx:5px;ry:5px}#mermaid-svg-h1GWqEQWEEE6LXij .statediagram-cluster.statediagram-cluster .inner{fill:white}#mermaid-svg-h1GWqEQWEEE6LXij .statediagram-cluster.statediagram-cluster-alt .inner{fill:#e0e0e0}#mermaid-svg-h1GWqEQWEEE6LXij .statediagram-cluster .inner{rx:0;ry:0}#mermaid-svg-h1GWqEQWEEE6LXij .statediagram-state rect.basic{rx:5px;ry:5px}#mermaid-svg-h1GWqEQWEEE6LXij .statediagram-state rect.divider{stroke-dasharray:10,10;fill:#efefef}#mermaid-svg-h1GWqEQWEEE6LXij .note-edge{stroke-dasharray:5}#mermaid-svg-h1GWqEQWEEE6LXij .statediagram-note rect{fill:#fff5ad;stroke:#aa3;stroke-width:1px;rx:0;ry:0}:root{--mermaid-font-family: '&quot;trebuchet ms&quot;, verdana, arial';--mermaid-font-family: &quot;Comic Sans MS&quot;, &quot;Comic Sans&quot;, cursive}#mermaid-svg-h1GWqEQWEEE6LXij .error-icon{fill:#522}#mermaid-svg-h1GWqEQWEEE6LXij .error-text{fill:#522;stroke:#522}#mermaid-svg-h1GWqEQWEEE6LXij .edge-thickness-normal{stroke-width:2px}#mermaid-svg-h1GWqEQWEEE6LXij .edge-thickness-thick{stroke-width:3.5px}#mermaid-svg-h1GWqEQWEEE6LXij .edge-pattern-solid{stroke-dasharray:0}#mermaid-svg-h1GWqEQWEEE6LXij .edge-pattern-dashed{stroke-dasharray:3}#mermaid-svg-h1GWqEQWEEE6LXij .edge-pattern-dotted{stroke-dasharray:2}#mermaid-svg-h1GWqEQWEEE6LXij .marker{fill:#333}#mermaid-svg-h1GWqEQWEEE6LXij .marker.cross{stroke:#333} :root { --mermaid-font-family: &quot;trebuchet ms&quot;, verdana, arial;} #mermaid-svg-h1GWqEQWEEE6LXij { color: rgba(0, 0, 0, 0.75); font: ; } fe dashboard proxy_A proxy_B redis_A redis_B client slotmgrate ok slotpreparing slotpreparing OK OK slotprepared slotprepared OK OK 迁移数据到redis_B上 slotsrestore-async ok 访问数据 先检查数据是否迁移到redis_B，如果没有则触发迁移该key操作 将该key迁移到redis_B 从redis_B访问该数据 返回结果 迁移完成 该slot迁移完成 该slot迁移完成 fe dashboard proxy_A proxy_B redis_A redis_B client</p> <h5 id="pika简介"><a href="#pika简介" class="header-anchor">#</a> pika简介</h5> <p>pika是360团队开源而来的一个兼容redis协议底层选用rocksdb的一个kv存储，该项目加入了开放原子开源基金会，并且在主流版本上面提供codis的接入能力。故考虑通过引入pika来替换codis中的codis-server组件。</p> <p>pika既支持单节点模式也支持分布式模式，即每个slot都可以通过单独的管理迁移。在业务实践中考虑到数据量相对较大，故在最开始的时候就是使用的<strong>分布式模式</strong>，在后续的设计改造中也是依据该模式进行。</p> <h5 id="pika接入codis的挑战"><a href="#pika接入codis的挑战" class="header-anchor">#</a> pika接入codis的挑战</h5> <h6 id="pika官方支持的codis-server的命令"><a href="#pika官方支持的codis-server的命令" class="header-anchor">#</a> pika官方支持的codis-server的命令</h6> <p>通过查阅pika的源码(3.4.0版本)，在位于pika_command.h头文件中找到如下。</p> <div class="language-c++ extra-class"><pre class="language-text"><code>//Codis Slots
const std::string kCmdNameSlotsInfo = &quot;slotsinfo&quot;;
const std::string kCmdNameSlotsHashKey = &quot;slotshashkey&quot;;
const std::string kCmdNameSlotsMgrtTagSlotAsync = &quot;slotsmgrttagslot-async&quot;;
const std::string kCmdNameSlotsMgrtSlotAsync = &quot;slotsmgrtslot-async&quot;;
const std::string kCmdNameSlotsDel = &quot;slotsdel&quot;;
const std::string kCmdNameSlotsScan = &quot;slotsscan&quot;;
const std::string kCmdNameSlotsMgrtExecWrapper = &quot;slotsmgrt-exec-wrapper&quot;;
const std::string kCmdNameSlotsMgrtAsyncStatus = &quot;slotsmgrt-async-status&quot;;
const std::string kCmdNameSlotsMgrtAsyncCancel = &quot;slotsmgrt-async-cancel&quot;;
const std::string kCmdNameSlotsMgrtSlot = &quot;slotsmgrtslot&quot;;
const std::string kCmdNameSlotsMgrtTagSlot = &quot;slotsmgrttagslot&quot;;
const std::string kCmdNameSlotsMgrtOne = &quot;slotsmgrtone&quot;;
const std::string kCmdNameSlotsMgrtTagOne = &quot;slotsmgrttagone&quot;;
</code></pre></div><p>对比查看一下codis-server支持的命令如下。</p> <div class="language-c extra-class"><pre class="language-c"><code>    <span class="token punctuation">{</span><span class="token string">&quot;slotsinfo&quot;</span><span class="token punctuation">,</span>slotsinfoCommand<span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">&quot;rF&quot;</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">&quot;slotsscan&quot;</span><span class="token punctuation">,</span>slotsscanCommand<span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">&quot;rR&quot;</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">&quot;slotsdel&quot;</span><span class="token punctuation">,</span>slotsdelCommand<span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">&quot;w&quot;</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">&quot;slotsmgrtslot&quot;</span><span class="token punctuation">,</span>slotsmgrtslotCommand<span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token string">&quot;w&quot;</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">&quot;slotsmgrttagslot&quot;</span><span class="token punctuation">,</span>slotsmgrttagslotCommand<span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token string">&quot;w&quot;</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">&quot;slotsmgrtone&quot;</span><span class="token punctuation">,</span>slotsmgrtoneCommand<span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token string">&quot;w&quot;</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">&quot;slotsmgrttagone&quot;</span><span class="token punctuation">,</span>slotsmgrttagoneCommand<span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token string">&quot;w&quot;</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">&quot;slotshashkey&quot;</span><span class="token punctuation">,</span>slotshashkeyCommand<span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">&quot;rF&quot;</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">&quot;slotscheck&quot;</span><span class="token punctuation">,</span>slotscheckCommand<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">&quot;r&quot;</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">&quot;slotsrestore&quot;</span><span class="token punctuation">,</span>slotsrestoreCommand<span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token string">&quot;wm&quot;</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">&quot;slotsmgrtslot-async&quot;</span><span class="token punctuation">,</span>slotsmgrtSlotAsyncCommand<span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">&quot;ws&quot;</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">&quot;slotsmgrttagslot-async&quot;</span><span class="token punctuation">,</span>slotsmgrtTagSlotAsyncCommand<span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">&quot;ws&quot;</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">&quot;slotsmgrtone-async&quot;</span><span class="token punctuation">,</span>slotsmgrtOneAsyncCommand<span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token string">&quot;ws&quot;</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">&quot;slotsmgrttagone-async&quot;</span><span class="token punctuation">,</span>slotsmgrtTagOneAsyncCommand<span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token string">&quot;ws&quot;</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">&quot;slotsmgrtone-async-dump&quot;</span><span class="token punctuation">,</span>slotsmgrtOneAsyncDumpCommand<span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token string">&quot;rm&quot;</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">&quot;slotsmgrttagone-async-dump&quot;</span><span class="token punctuation">,</span>slotsmgrtTagOneAsyncDumpCommand<span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token string">&quot;rm&quot;</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">&quot;slotsmgrt-async-fence&quot;</span><span class="token punctuation">,</span>slotsmgrtAsyncFenceCommand<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">&quot;rs&quot;</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">&quot;slotsmgrt-async-cancel&quot;</span><span class="token punctuation">,</span>slotsmgrtAsyncCancelCommand<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">&quot;F&quot;</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">&quot;slotsmgrt-async-status&quot;</span><span class="token punctuation">,</span>slotsmgrtAsyncStatusCommand<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">&quot;F&quot;</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">&quot;slotsmgrt-exec-wrapper&quot;</span><span class="token punctuation">,</span>slotsmgrtExecWrapperCommand<span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">&quot;wm&quot;</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">&quot;slotsrestore-async&quot;</span><span class="token punctuation">,</span>slotsrestoreAsyncCommand<span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">&quot;wm&quot;</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">&quot;slotsrestore-async-auth&quot;</span><span class="token punctuation">,</span>slotsrestoreAsyncAuthCommand<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">&quot;sltF&quot;</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">&quot;slotsrestore-async-select&quot;</span><span class="token punctuation">,</span>slotsrestoreAsyncSelectCommand<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">&quot;lF&quot;</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">&quot;slotsrestore-async-ack&quot;</span><span class="token punctuation">,</span>slotsrestoreAsyncAckCommand<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">&quot;w&quot;</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p>对比而言发现pika实现的命令相对较少，那具体接入codis中能否正常使用还有待观察，并且在codis-server和pika支持的语法上面来讲当前就已经有所不同。</p> <p>在pika的集群模式下面需要输入如下指令。</p> <div class="language-shell extra-class"><pre class="language-shell"><code>redis-cli <span class="token parameter variable">-p</span> <span class="token number">9221</span> pkcluster slot info <span class="token number">1</span>
</code></pre></div><p>这也意味着，在命令调度与管理层也必须加上对于pika的语法格式的支持。</p> <p>在前期的调研阶段得益于研发同学的大力支持，在codis-dashboard层中，通过修改部分源码逻辑来支持有关pika的主从同步、主从提升等命令，从而完成了在codis-fe层面的操作。</p> <p>在完成了如上的操作之后，继续进行数据迁移的时候，发现在codis-fe界面上面都显示迁移完成，但是数据却并没有迁移，导致新迁移的数据其实并没有迁移对对应的集群上面去。具体为什么会出现如下的问题呢？在codis-fe界面上面也没有明显的报错信息，问题出在了哪里呢？</p> <p>此时继续查看一下pika的有关slot的源码。</p> <div class="language-c++ extra-class"><pre class="language-text"><code>void SlotsMgrtSlotAsyncCmd::Do(std::shared_ptr&lt;Partition&gt; partition) {
  int64_t moved = 0;
  int64_t remained = 0;
  res_.AppendArrayLen(2);
  res_.AppendInteger(moved);
  res_.AppendInteger(remained);
}
</code></pre></div><p>从源码查看发现，我们日常运行的情况下，通过codis-dashboard发送给pika的指令直接就是成功返回，从而使codis-dashboard在迁移的时候就立马就收到了成功的信号，从而直接就修改了迁移的状态到成功，但是其实数据迁移并没有执行。</p> <p>针对这种情况，我们查阅了有关pika的官方文档 <a href="https://github.com/OpenAtomFoundation/pika/wiki/Support-Cluster-Slots" target="_blank" rel="noopener noreferrer">Pika配合Codis扩容案例<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>从官方的文档来看，这种迁移的方案是一种有损可能会丢数据的方案，在这种情况下需要依靠自己来调整迁移的方案。</p> <h6 id="pika迁移工具的设计"><a href="#pika迁移工具的设计" class="header-anchor">#</a> pika迁移工具的设计</h6> <p>迁移工具的整体流程如下：</p> <p>原始集群信息如下</p> <p><img src="https://img-blog.csdnimg.cn/8243b2f2bf824af38c98510dc300fed1.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5bCP5bGL5a2Q5aSn5L6g,size_18,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="在这里插入图片描述"></p> <p>此时需要迁移901-1023个slot信息迁移到新组件上面即group4作为新实例提供服务。</p> <p>首先开发一个pika的迁移工具，该工具可以转发代理codis的请求。先将801-1023的信息迁移到pika的迁移工具。</p> <p><img src="https://img-blog.csdnimg.cn/1799bb9c7f534c598762b1e6b4ff3454.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5bCP5bGL5a2Q5aSn5L6g,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="在这里插入图片描述"></p> <p>此时pika迁移工具就将801-900的写信息写入group3，将901-1023的写信息写入group4，然后如果查数据先查group4，如果没有则查group3。</p> <p>此时pika迁移工具接入完成之后，转发代理到后端服务。接入完成之后再进行主从同步信息，将group3同步到group4。</p> <p><img src="https://img-blog.csdnimg.cn/5537e313a8be46518c6799801f207a39.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5bCP5bGL5a2Q5aSn5L6g,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="在这里插入图片描述"></p> <p>将slot901-1023的数据从group3迁移到group4上面之后，因为没有新的group3的901-1023的数据写入，故可以放心的等待数据迁移完成。</p> <p>迁移完成之后就断开主从，再将pika的迁移工具的slot信息，即801-900迁移回group3，将901-1023迁移回group4，此时数据迁移完成。</p> <p><img src="https://img-blog.csdnimg.cn/781f01558ba64a278e6314cc7cb0315f.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5bCP5bGL5a2Q5aSn5L6g,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="在这里插入图片描述"></p> <p>至此，pika通过迁移工具完成对集群的扩容，该工具大部分工具跟codis-proxy的大部分功能相似，只不过需要将对应的路由规则进行转换并添加上对于pika的语法指令就可以了。</p> <h5 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h5> <p>本文仅仅是针对pika在codis场景下的一些思考和探索。由于本人才疏学浅，如有错误请批评指正。</p></div></section> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/document/design/副本一致性.html" class="prev">
          副本一致性
        </a></span> <span class="next"><a href="/document/design/快照式备份.html">
          快照式备份
        </a></span></p></div> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:0;" data-v-b57cc07c data-v-7dd95ae2></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/assets/js/app.f4c49bff.js" defer></script><script src="/assets/js/7.1224f65b.js" defer></script><script src="/assets/js/2.9fbd6685.js" defer></script><script src="/assets/js/1.77f24ecd.js" defer></script><script src="/assets/js/51.367b8ed7.js" defer></script>
  </body>
</html>
